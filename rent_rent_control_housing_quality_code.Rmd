---
title: "rent_control_and_housing_quality"
author: "Leon Ivo litera"
date: "18 11 2022"
output: html_document
---
 
```{r}
#packages
library(haven)
library(dplyr)
library(data.table)
library(here)
library(did)
library(ggplot2)
library(tidyverse)
library(rvest)
library(pdftools)
library(zoo)
library(lubridate)
library(ipumsr)
library(withr)
library(naniar)
library(ggpubr)
library(data.table)
library(stringr)
library(rlist)
```



```{r}
#set working directory
setwd("~/rent_control")
```
 
 
```{r eval=FALSE, include=FALSE}

####1import,2merge, and 3convert data in to a usefull csv format####


#import data in stata format
for (i in 1:10) {
 fn <- paste0("WM_SUF",i)
 pth <- paste0("~/rent_control/data/raw/WM_SUF/WM_SUF",i, ".dta")
 assign(fn, read_dta(pth))
}


#rbind ("merge") the different waves
#list for the df's
WM_SUF_list <- list() 
#import df's into the list
WM_SUF_list <- mget(ls(pattern = "WM_SUF[1-10]")) 
#rbind the df's out of the list
WM_SUF <- data.table::rbindlist(WM_SUF_list,
                                fill = T)

#remove unnecessary data frames from th environment, to keep memory free
rm(WM_SUF_list, 
   WM_SUF1,
   WM_SUF2,
   WM_SUF3,
   WM_SUF4,
   WM_SUF5,
   WM_SUF6,
   WM_SUF7,
   WM_SUF8,
   WM_SUF9,
   WM_SUF10
   )




#save as csv data set
#write with fread #fread is faster than write.csv
fwrite(WM_SUF,
       file = here("data/raw/WM_SUF.csv"), 
       sep = ",")

rm(WM_SUF,
   fn,
   pth)

```


```{r}
#import data in csv format #fast
WM_SUF <- fread(here("data/raw/WM_SUF.csv"),
                sep = ",",
                dec = ".")


```


```{r}
#import data with rc policys

city_rc <- fread(here("data/raw/Liste_aller_Gemeinden_mit_MPB.csv"),
                sep = ";",
                dec = ".",
                encoding = "UTF-8",
                header = T)


city_rc$aRC_Time1 <- as.Date(parse_date_time(city_rc$aRC_Time1, c('dmy')))
city_rc$eRC_Time1 <- as.Date(parse_date_time(city_rc$eRC_Time1, c('dmy')))


city_rc$aRC_Time2 <- as.Date(parse_date_time(city_rc$aRC_Time2, c('dmy')))
city_rc$eRC_Time2 <- as.Date(parse_date_time(city_rc$eRC_Time2, c('dmy')))


city_rc$aRC_Time3 <- as.Date(parse_date_time(city_rc$aRC_Time3, c('dmy')))
city_rc$eRC_Time3 <- as.Date(parse_date_time(city_rc$eRC_Time3, c('dmy')))

```


```{r eval=FALSE, include=FALSE}
#scrape table from the pdf with the AGS (Gemeindekennziffern 2015)
#to merge city_rc with WM_SUF

#location of pdf file with the ags table
urls_AGS <- "https://www.riserid.eu/data/user_upload/downloads/info-pdf.s/Diverses/Liste-Amtlicher-Gemeindeschluessel-AGS-2015.pdf"


txt <- pdf_text(urls_AGS)
txt <- txt %>% str_split("\n")

#each case should only exist once....
ags_1 <- unique(txt)
rm(txt)

#deletes all elements that does not contain ags numbers
txt1 <- unlist(lapply(ags_1, function(ch) grep("\\d{8}", ch, value = TRUE)))
rm(ags_1)
txt12 <- gsub("\\s{2,}",",",txt1) #any white space of two or more =,
rm(txt1)

#change format from value to tibble
txt2 <- txt12 %>% as_tibble(.name_repair = make.names) 
rm(txt12)

#save data seperatet with ","
fwrite(txt2,
       file = here("data/raw/txt2.csv"),
       sep = ",",
       bom = T)
rm(txt2)

#read data as csv to generate columnes
txt3 <- fread(here("data/raw/txt2.csv"),
                sep = ",",
                dec = ".",
              encoding = "UTF-8"
              )

#cutting '"' characters
txt3$Name <- substring(txt3$value, 2)
txt3$value <- NULL

txt3$Bundesland <- substr(txt3$V4,1,nchar(txt3$V4)-1)
txt3$V4 <- NULL

#rename vaiables
txt3 <- rename(txt3, Gemeindeschluessel = V3)
txt3 <- rename(txt3, Verwaltungseinheit = V2)


fwrite(txt3,
       file = here("data/tidy/AGS_data15.csv"),
       sep = ",",
       bom = T)
rm(txt3, urls_AGS)


```

```{r}
#import tidy AGS data_15
AGS_15 <- fread(here("data/tidy/AGS_data15.csv"),
                sep = ",",
                dec = ".",
                encoding = "UTF-8")

n_ags <- AGS_15%>%select(Name)%>%unique()

```


```{r}

#rename variables for joining
city_rc <- rename(city_rc, Name = Stadt)

#merge data frames
AGS_15_rc <- left_join(AGS_15,city_rc,
                       by=NULL,
                       copy = F)


rm(AGS_15,city_rc)

```



```{r}
#merge rent control city data and immoscout data
#dafür nur noch den ags code und die treatment sachen drinnlassen #namen rausschmeißen

AGS_15_rc <- rename(AGS_15_rc, gid2015 = Gemeindeschluessel)

AGS_15_rc <- rename(AGS_15_rc, city_name = Name)
 
md <- left_join(WM_SUF, AGS_15_rc, 
                by= c("gid2015"="gid2015"),
                copy = F)

rm(WM_SUF)


#keep only cases that have a location ags/gid/cityname
md <- md%>% filter(gid2015 != -9)


#leading zeros at the gid15 code
md$gid2015 <- with_options(
                       c(scipen = 999), 
                       str_pad(md$gid2015, 8, pad = "0")
   )


##select variables
md <- md %>% select(gid2015,
                      city_name,
                      baujahr,
                      objektzustand,
                      letzte_modernisierung,
                      obid,
                      spell,
                      Bundesland,
                      mietekalt,
                      mietewarm,
                      aRC_Time1,
                      aRC_Time2,
                      aRC_Time3,
                      eRC_Time1,
                      eRC_Time2,
                      eRC_Time3,
                      reRCt1,
                      reRCt2,
                      reRCt3,
                      plz,
                      wohnflaeche,
                      nutzflaeche,
                      zimmeranzahl,
                      ev_kennwert,
                      ev_wwenthalten,
                      energieausweistyp,
                      energieeffizienzklasse,
                      jahr,
                      emonat,
                      heizungsart
                      )



###treatment variable
#add day to year and mont of each advertisment
md$etag <- 1
#get a single columne with the end date of each apartment advertisment instead of two seperate ones
md$eDate <- paste(md$jahr, md$emonat, md$etag, sep="-") %>% ymd() %>% as.Date()

#Q_Time: time period of the analysis
md$Q_time <- md$eDate 


#####save
fwrite(md,
       file = here("data/raw/md.csv"), 
       sep = ",")


```






```{r}
###################################
#data cleaning
#delete all cases with unplausible or missing data that could disrupt the calculation or analysis
###################################


#generate NA's
md <- naniar::replace_with_na(md,
                               replace = list(mietewarm = c(-11:-5,0), #0 is no realistic -> NA
                                              mietekalt = c(-11:-5,0), #0 is no realistic -> NA
                                              letzte_modernisierung = c(-11:-5),
                                              objektzustand = c(-11:-5),
                                              wohnflaeche = c(-11:-5,0), #0 is no realistic -> NA
                                              nutzflaeche = c(-11:-5),
                                              obid = c(-11:-5),
                                              plz = c(-11:-5),
                                              spell = c(-11:-5),
                                              zimmeranzahl = c(-11:-5),
                                              jahr = c(-11:-5), 
                                              baujahr = c(-11:-5, -1), 
                                              emonat = c(-11:-5),
                                              energieausweistyp = c(-11:-5),
                                              energieeffizienzklasse = c(-11:-5),
                                              ev_kennwert = c(-11:-5),
                                              heizungsart = c(-11:-5),
                                              gid2015 = c(-11:-5)
                                              ))



#variabel with character values for objektzustand

md <- md %>% mutate(ob_zu = case_when(objektzustand == NA ~ "Keine Angabe",
                                            objektzustand == 1 ~ "Erstbezug",
                                            objektzustand == 2 ~ "Erstbezug_nach_Sanierung",
                                            objektzustand == 3 ~ "Neuwertig",
                                            objektzustand == 4 ~ "Saniert",
                                            objektzustand == 5 ~ "Modernisiert",
                                            objektzustand == 6 ~ "Vollstaendig_Renoviert",
                                            objektzustand == 7 ~ "Gepflegt",
                                            objektzustand == 8 ~ "Renovierungsbeduerftig",
                                            objektzustand == 9 ~ "Nach_Vereinbarung",
                                            objektzustand == 10 ~ "Abbruchreif",
                                            TRUE ~ as.character(objektzustand)))


gc()

fwrite(md,
       file = here("data/raw/md_backup3.csv"), 
       sep = ",")

fwrite(n_ags,
       file = here("data/raw/n_ags_backup.csv"), 
       sep = ",")

fwrite(AGS_15_rc,
       file = here("data/raw/AGS_15_rc_backup.csv"), 
       sep = ",")

```

```{r}
###
####generate variables and clean data
###


#flat size lower then 10 is unrealistic
#or landlords are to lazy to fill in korrekt data
md$wohnflaeche <- md$wohnflaeche %>% replace(md$wohnflaeche < 10, NA)

#calculate rent for sqm
md$p_sqm <-md$mietekalt / md$wohnflaeche


############
#psqm is propably not realistic if it is below 1
md$p_sqm <- md$p_sqm %>% replace(md$p_sqm < 1, NA)

summary(md$p_sqm)

#one year median of price per m² in a district

md <- md %>%
  group_by(jahr, .add = T) %>% 
  group_by(plz, .add = T) %>%
  mutate(median_psqm_jplz = median(p_sqm, na.rm = T))

md <- ungroup(md)

summary(md$median_psqm_jplz)

#one year median of of price per m²in the city (gid2015)
md <- md %>%
  group_by(jahr, .add = T) %>% 
  group_by(gid2015, .add = T) %>%
  mutate(median_psqm_jcity = median(p_sqm, na.rm = T))

md <- ungroup(md)


q = c(.25, .75)

#calculate quantiles by grouping variable
bd <- md %>%
  group_by(jahr, .add = T) %>% 
  group_by(gid2015, .add = T) %>%
  summarize(quant25 = quantile(median_psqm_jplz, probs = q[1], na.rm = T),
            quant75 = quantile(median_psqm_jplz, probs = q[2], na.rm = T))

md <- ungroup(md)

#join bd on gid and year with md


md <- left_join(md, bd)


#sd of sqmp to the median in a city
md <- md %>%
  group_by(jahr, .add = T) %>% 
  group_by(gid2015, .add = T) %>%
  mutate(sd_psqm_jcity = sd(p_sqm, na.rm = T))

md <- ungroup(md)

######

#1. Variable für wohnraum der in gutem oder schlechtem zustand ist
###

md <- md %>% mutate(ob_inv = case_when(objektzustand == NA ~ "no_inv", #NA
                                            objektzustand == 1 ~ "inv", #erstbezug
                                            objektzustand == 2 ~ "inv",#erstbezug nach sanierung
                                            objektzustand == 3 ~ "inv", # neuwertig
                                            objektzustand == 4 ~ "inv",#saniert
                                            objektzustand == 5 ~ "inv",#modernisiert
                                            objektzustand == 6 ~ "inv",#vollständig renoviert
                                            objektzustand == 7 ~ "no_inv",#gepflegt?
                                            objektzustand == 8 ~ "no_inv",#renovierungsbedürftig
                                            objektzustand == 9 ~ "no_inv",#nach vereinabrung
                                            objektzustand == 10 ~ "no_inv",#abbruchreif
                                            TRUE ~ as.character(objektzustand)))

md$ob_inv[is.na(md$ob_inv)] <- "no_inv"





#a_pc
#gives a value back if a add is expensive or cheap in relation to the median of price of a district
md <- md %>% mutate(a_pc = case_when(p_sqm >= median_psqm_jplz ~ "expensiv",
                                     p_sqm <= median_psqm_jplz ~ "cheap"))





#nei_lmh

#high 
mdh <- md %>% 
  filter(median_psqm_jplz > quant75)


mdh$nei_lmh <- "high_priced"



mdm <- md%>%
  filter(median_psqm_jplz <= quant75) %>%
  filter(median_psqm_jplz >= quant25 )



mdm$nei_lmh <- "medium_priced"


#low
mdl <- md%>% 
  filter(median_psqm_jplz < quant25 )



mdl$nei_lmh <- "low_priced"

nrow(md)-(nrow(mdh)+nrow(mdm)+nrow(mdl))

#na cases
mdna <- md %>% filter(is.na(median_psqm_jplz))



gc()
#row bind the three group datasets
#md <- bind_rows(mdh, mdm, mdl, mdna)
md <- rbindlist(list(mdh, mdm, mdl, mdna), fill = T) # data table version that uses less memmory
rm(mdh, mdm, mdl, mdna)



#md_tg Data set reduced with group names and city names
#md_tg <- md%>%select(gid2015,Q_time,treat_G) #brauch man nach umschreiben in v2 nicht mehr 
gc()
```



```{r}
#data wrangling
#generate a panel dataset (pd)
##the object of interest are the citys and not the flats
#t: is time periode
#n: are the number of cases/adds for a city
#ad: advertisment/adds/case
#p: panel

#count adds for each city and year and q_time
pd <- data_frame()
pd <- md%>%count(jahr, Q_time, gid2015)
pd <- rename(pd, n_adtc=n) #n_adtc = number of adds/cases in t and city


#count adds for each objektzustand
poz <- data_frame()
poz <- md%>%count(jahr, Q_time, gid2015, ob_zu)
poz <- rename(poz, n_adtc_obzu=n) #n_adtc_obzu = number of adds/cases with ob_zu in t


#merge overall number of adds per city and t with overall cases numbers
poz <- left_join(poz,pd)


#count flats in that landlords investet money
#c_inv and c_no_inv are the number of cases per City and q_time in which money was investet or not

inv <- data_frame()
inv <- md%>%count(jahr,Q_time, gid2015, ob_inv)
inv <- rename(inv, n_inv_tc=n)# number of flats in that the landlords investet in the city at q_time

#merge
inv <- left_join(inv, pd)

inv <- inv %>% pivot_wider(names_from = ob_inv,  
                     values_from = n_inv_tc,
                     names_prefix = "c_")

poz <- left_join(poz, inv)

#n_lmhd_obzu: number of adds in high medium low neighberhood with obzu=xy
#count adds in low, medium, high priced districts per ob_zu
lmhd <- data.frame()
lmhd <- md%>%count(jahr, Q_time, gid2015, ob_zu, nei_lmh)
lmhd <- lmhd%>%rename(n_lmhd_obzu=n)
lmhd <- lmhd%>%pivot_wider(names_from = nei_lmh,
                            values_from = n_lmhd_obzu,
                            names_prefix = "n_nei_")

#get nas for zero counts
lmhd$n_nei_high_priced[is.na(lmhd$n_nei_high_priced)] <- 0 
lmhd$n_nei_medium_priced[is.na(lmhd$n_nei_medium_priced)] <- 0 
lmhd$n_nei_low_priced[is.na(lmhd$n_nei_low_priced)] <- 0 
lmhd$n_nei_NA[is.na(lmhd$n_nei_NA)] <- 0 

lmhd <- left_join(lmhd, pd)
rd <- left_join(poz, lmhd)
rm(poz, lmhd, inv) 


# number of flats in high medium low neighberhoods with investments in obzu tc
#count adds in low, medium, high priced districts per ob_inv
#c_high_priced_inv,
#c_medium_priced_inv,
#c_low_priced_inv,
#c_high_priced_no_inv,
#c_medium_priced_no_inv,
#c_low_priced_no_inv,
ni <- data.frame()
ni <- md%>%count(jahr, Q_time, gid2015, ob_inv, nei_lmh)
ni <- ni%>%rename(n_lmhd_inv=n)

ni <- ni%>%pivot_wider(names_from = nei_lmh,
                    values_from = n_lmhd_inv,
                    names_prefix = "c_")

ni<- ni%>%select(-c_NA)

ni <- ni%>%pivot_wider(names_from = ob_inv,
                            values_from = c(c_high_priced,c_medium_priced,c_low_priced))

#set na's to zero
ni$c_high_priced_inv[is.na(ni$c_high_priced_inv)] <- 0
ni$c_medium_priced_inv[is.na(ni$c_medium_priced_inv)] <- 0
ni$c_low_priced_inv[is.na(ni$c_low_priced_inv)] <- 0

ni$c_high_priced_inv[is.na(ni$c_high_priced_no_inv)] <- 0
ni$c_medium_priced_inv[is.na(ni$c_medium_priced_no_inv)] <- 0
ni$c_low_priced_inv[is.na(ni$c_low_priced_no_inv)] <- 0

rd <- left_join(rd, ni)
rm(ni)


#Relabel NA Values
rd$ob_zu <- rd$ob_zu%>%replace_na("Unbekannter_Zustand")



#RC variabele

AGS_15_rc$gid2015 <- with_options(
                       c(scipen = 999), 
                       str_pad(AGS_15_rc$gid2015, 8, pad = "0"))

AGS_15_rc$gid2015 <- as.numeric(AGS_15_rc$gid2015 )

AGS_15_rc$gid2015 <- as.numeric(AGS_15_rc$gid2015)
rd$gid2015 <- as.numeric(rd$gid2015)
rd <- left_join(rd, AGS_15_rc)


rm(AGS_15_rc,pd)

#remove md to keep environemnt clean
rm(md)



#round time to month


#round start date to floor
rd$aRC_Time1 <- rd$aRC_Time1 %>%
  lubridate::floor_date(unit = "month") #test with quarter

rd$aRC_Time2 <- rd$aRC_Time2 %>%
  lubridate::floor_date(unit = "month")

rd$aRC_Time3 <- rd$aRC_Time3 %>%
  lubridate::floor_date(unit = "month")


#round end date to ceiling
rd$eRC_Time1 <- rd$eRC_Time1 %>%
  lubridate::ceiling_date(unit = "month")

rd$eRC_Time2 <- rd$eRC_Time2 %>%
  lubridate::ceiling_date(unit = "month")

rd$eRC_Time3 <- rd$eRC_Time3 %>%
  lubridate::ceiling_date(unit = "month")


#generate intervals
rd$RCinter1 <- interval(rd$aRC_Time1, rd$eRC_Time1)
rd$RCinter2 <- interval(rd$aRC_Time2, rd$eRC_Time2)
rd$RCinter3 <- interval(rd$aRC_Time3, rd$eRC_Time3)



#is the end of a advertisment in a treatment interval?
rd$RC_Treatment1 <- rd$Q_time %within% rd$RCinter1
rd$RC_Treatment2 <- rd$Q_time %within% rd$RCinter2
rd$RC_Treatment3 <- rd$Q_time %within% rd$RCinter3

#convert NA's in treatment as FALSE
rd$RC_Treatment1[is.na(rd$RC_Treatment1)] <- FALSE 
rd$RC_Treatment2[is.na(rd$RC_Treatment2)] <- FALSE
rd$RC_Treatment3[is.na(rd$RC_Treatment3)] <- FALSE 
 

####################
#version with filter/subset and row bind again
#generate 4 data subsets, 3 treated, 1 never treated, bind them again
rd_sub1 <- rd%>% filter(rd$RC_Treatment1 == T)#cases with treatment in first wave
rd_sub1$RC <- T # generate TRUE treatment variable
rd_sub_f23 <- rd%>%filter(rd$RC_Treatment1 == F) # left over variables
rm(rd)

rd_sub2 <- rd_sub_f23%>% filter(rd_sub_f23$RC_Treatment2 == T)
rd_sub2$RC <- T
rd_sub_f3 <- rd_sub_f23%>%filter(rd_sub_f23$RC_Treatment2 == F) #left over variables
rm(rd_sub_f23)

rd_sub3 <- rd_sub_f3%>% filter(rd_sub_f3$RC_Treatment3 == T)
rd_sub3$RC <- T
rd_sub_f <- rd_sub_f3%>%filter(rd_sub_f3$RC_Treatment3 == F)#left over variables, never treated yet
rd_sub_f$RC <- F
rm(rd_sub_f3)

#row bind 
rd <-  bind_rows(rd_sub1,
                 rd_sub2, 
                 rd_sub3,
                 rd_sub_f)
rm(rd_sub1, rd_sub2, rd_sub3, rd_sub_f)
```



```{r include=FALSE}
#generate treatment groups and time vars for them


#first split the dataset in to cases that are treatet at the moment and cases that are not treatet at the moment

trt_grp <- list()
nty <- list()
ft <- list()
nta1 <- list()
st <- list()
nta2 <- list()


#treated cases
trt <- rd %>% filter(RC==T)

#first treatment in first treatment wave of a bundesland
ft_w1 <- trt %>% filter(RC_Treatment1==T)
#remove these cases from the trt data that is not categorized at the moment
trt <- trt %>% anti_join(ft_w1)
#get new columne for subgroup
ft_w1$TG <- 1 #numeric var for treat group
ft_w1$TG_name <- "ft" #abbrevation frour group
ft_w1$TG_time <-  ft_w1$aRC_Time1#start of beeing in that group
#save in list
ft[["ft_w1"]] <-ft_w1
rm(ft_w1)

#now all ft cases that start in the second wave
ft_w2 <- trt %>% filter(RC_Treatment2==T & is.na(RCinter1)==T)#no treatment in first wave
#remove these cases from trt
trt <- trt %>% anti_join(ft_w2)
#get new columne for subgroup
ft_w2$TG <- 1 #numeric var for treat group
ft_w2$TG_name <- "ft" #abbrevation frour group
ft_w2$TG_time <-  ft_w2$aRC_Time2#start of beeing in that group
#save in list
ft[["ft_w2"]] <-ft_w2
rm(ft_w2)


#now all ft cases that start in the third wave
#first filter for RC3 true and 1 empty than in a secon step rc3 true and 2 empty
ft_w3 <- trt %>% filter(RC_Treatment3==T & is.na(RCinter1)==T & is.na(RCinter2)==T)#no treatment in first wave
#remove these cases from trt
trt <- trt %>% anti_join(ft_w3)
#get new columne for subgroup
ft_w3$TG <- 1 #numeric var for treat group
ft_w3$TG_name <- "ft" #abbrevation frour group
ft_w3$TG_time <-  ft_w3$aRC_Time3#start of beeing in that group
#save in list
ft[["ft_w3"]] <-ft_w3
rm(ft_w3)

#all ft cases that are in theier first treatment also in the wave that follows up
#ft in second wave 
ft_w2ho <- trt %>% filter(RC_Treatment2 == T & reRCt1 == "ausgelaufen")
#remove these cases from trt
trt <- trt %>% anti_join(ft_w2ho)
#get new columne for subgroup
ft_w2ho$TG <- 1 #numeric var for treat group
ft_w2ho$TG_name <- "ft" #abbrevation frour group
ft_w2ho$TG_time <-  ft_w2ho$aRC_Time1#start of beeing in that group
#save in list
ft[["ft_w2ho"]] <-ft_w2ho
rm(ft_w2ho)

#all ft cases that are in theier first treatment also in the wave that follows up
#third wave with ft from wave 2
ft_w3ho <- trt %>% filter(RC_Treatment3 == T & reRCt2 == "ausgelaufen" & is.na(RCinter1)==T)
#remove these cases from trt
trt <- trt %>% anti_join(ft_w3ho)
#get new columne for subgroup
ft_w3ho$TG <- 1 #numeric var for treat group
ft_w3ho$TG_name <- "ft" #abbrevation frour group
ft_w3ho$TG_time <-  ft_w3ho$aRC_Time2#start of beeing in that group
#save in list
ft[["ft_w3ho"]] <-ft_w3ho
rm(ft_w3ho)

#all ft cases that are in theier first treatment also in all waves following up
ft_w23ho <- trt %>% filter(RC_Treatment3 == T &  
                           reRCt1 == "ausgelaufen" &
                           reRCt2 == "ausgelaufen")
#remove these cases from trt
trt <- trt %>% anti_join(ft_w23ho)
#get new columne for subgroup
ft_w23ho$TG <- 1 #numeric var for treat group
ft_w23ho$TG_name <- "ft" #abbrevation frour group
ft_w23ho$TG_time <-  ft_w23ho$aRC_Time1#start of beeing in that group
#save in list
ft[["ft_w23ho"]] <-ft_w23ho
rm(ft_w23ho)


#second treatment in second wave:
st_w2 <- trt %>% filter(RC_Treatment2 == T & reRCt1== "gekippt")
#remove these cases from trt
trt <- trt %>% anti_join(st_w2)
#get new columne for subgroup
st_w2$TG <- 2 #numeric var for treat group
st_w2$TG_name <- "st" #abbrevation frour group
st_w2$TG_time <-  st_w2$aRC_Time2#start of beeing in that group
#save in list
st[["st_w2"]] <- st_w2
rm(st_w2)


#second treatment in third wave:
st_w3 <- trt %>% filter(RC_Treatment3 == T & reRCt2== "gekippt" & RCinter1 == F)
#remove these cases from trt
trt <- trt %>% anti_join(st_w3)
#get new columne for subgroup
st_w3$TG <- 2 #numeric var for treat group
st_w3$TG_name <- "st" #abbrevation frour group
st_w3$TG_time <-  st_w3$aRC_Time3#start of beeing in that group
#save in list
st[["st_w3"]] <- st_w3
rm(st_w3)

#second treatment continued in third wave:
st_w23 <- trt %>% filter(RC_Treatment3 == T & reRCt1== "gekippt" & reRCt2 == "ausgelaufen")
#remove these cases from trt
trt <- trt %>% anti_join(st_w23)
#get new columne for subgroup
st_w23$TG <- 2 #numeric var for treat group
st_w23$TG_name <- "st" #abbrevation frour group
st_w23$TG_time <-  st_w23$aRC_Time2#start of beeing in that group
#save in list
st[["st_w23"]] <- st_w23
rm(st_w23)

rm(trt)



#not treated cases
nt <- rd %>% filter(RC== F)

#never treated cases
nt_nv <- nt %>% filter(is.na(RCinter1)==T & is.na(RCinter2)==T & is.na(RCinter3)==T)
#remove these cases from nt
nt <- nt %>% anti_join(nt_nv)
#get new columne for subgroup
nt_nv$TG <- 0 #numeric var for treat group
nt_nv$TG_name <- "notreatment" #abbrevation frour group
nt_nv$TG_time <-  ""#start of beeing in that group
#save in list
nty[["nt_nv"]] <- nt_nv
rm(nt_nv)

#not yet treated before first treatment
nty_w1 <-  nt %>% filter(is.na(RCinter1)==F &
                         Q_time < aRC_Time1)
#remove these cases from nt
nt <- nt %>% anti_join(nty_w1)
#get new columne for subgroup
nty_w1$TG <- 0 #numeric var for treat group
nty_w1$TG_name <- "notreatment" #abbrevation frour group
nty_w1$TG_time <-  ""#start of beeing in that group
#save in list
nty[["nty_w1"]] <- nty_w1
rm(nty_w1)

#before ft in second wave
nty_w2 <-  nt %>% filter(is.na(RCinter1)==T &
                         is.na(RCinter2)==F &
                         Q_time < aRC_Time2)
#remove these cases from nt
nt <- nt %>% anti_join(nty_w2)
#get new columne for subgroup
nty_w2$TG <- 0 #numeric var for treat group
nty_w2$TG_name <- "notreatment" #abbrevation frour group
nty_w2$TG_time <-  ""#start of beeing in that group
#save in list
nty[["nty_w2"]] <- nty_w2
rm(nty_w2)

#before ft in third wave
nty_w3 <-  nt %>% filter(is.na(RCinter1)==T &
                         is.na(RCinter2)==T &
                         is.na(RCinter3)==F &
                         Q_time < aRC_Time3)
#remove these cases from nt
nt <- nt %>% anti_join(nty_w3)
#get new columne for subgroup
nty_w3$TG <- 0 #numeric var for treat group
nty_w3$TG_name <- "notreatment" #abbrevation frour group
nty_w3$TG_time <-  ""#start of beeing in that group
#save in list
nty[["nty_w3"]] <- nty_w3
rm(nty_w3)


#not treated any more, first time
#after ft wave 1 before st in wave 2
nta1_w1 <- nt %>% filter(is.na(RCinter1)==F & 
                         is.na(RCinter2)==F &
                         reRCt1 == "gekippt" &
                         Q_time < aRC_Time2 &
                         Q_time > eRC_Time1)
#remove these cases from nt
nt <- nt %>% anti_join(nta1_w1)
#get new columne for subgroup
nta1_w1$TG <- 3 #numeric var for treat group
nta1_w1$TG_name <- "ntaft" #abbrevation frour group
nta1_w1$TG_time <-  nta1_w1$eRC_Time1#start of beeing in that group
#save in list
nta1[["nta1_w1"]] <- nta1_w1
rm(nta1_w1)


#not treated any more, first time
#after ft wave 2 before st in wave 3
nta1_w2 <- nt %>% filter(is.na(RCinter1)==T & 
                         is.na(RCinter2)==F &
                         is.na(RCinter3)==F &
                         reRCt2 == "gekippt" &
                         Q_time < aRC_Time3 &
                         Q_time > eRC_Time2)
#remove these cases from nt
nt <- nt %>% anti_join(nta1_w2)
#get new columne for subgroup
nta1_w2$TG <- 3 #numeric var for treat group
nta1_w2$TG_name <- "ntaft" #abbrevation frour group
nta1_w2$TG_time <-  nta1_w2$eRC_Time2#start of beeing in that group
#save in list
nta1[["nta1_w2"]] <- nta1_w2
rm(nta1_w2)

#after ft in wave 1 before st in wave 3
nta1_w3 <- nt %>% filter(is.na(RCinter1)==F & 
                         is.na(RCinter2)==T &
                         is.na(RCinter3)==F &
                         Q_time < aRC_Time3 &
                         Q_time > eRC_Time1)
#remove these cases from nt
nt <- nt %>% anti_join(nta1_w3)
#get new columne for subgroup
nta1_w3$TG <- 3 #numeric var for treat group
nta1_w3$TG_name <- "ntaft" #abbrevation frour group
nta1_w3$TG_time <-  nta1_w3$eRC_Time1#start of beeing in that group
#save in list
nta1[["nta1_w3"]] <- nta1_w3
rm(nta1_w3)

#cases with only one treatment that has ended in wave 1
nta1_w1f <- nt %>% filter(is.na(RCinter1)==F & 
                         is.na(RCinter2)==T &
                         is.na(RCinter3)==T &
                         Q_time > eRC_Time1)
#remove these cases from nt
nt <- nt %>% anti_join(nta1_w1f)
#get new columne for subgroup
nta1_w1f$TG <- 3 #numeric var for treat group
nta1_w1f$TG_name <- "ntaft" #abbrevation frour group
nta1_w1f$TG_time <-  nta1_w1f$eRC_Time1#start of beeing in that group
#save in list
nta1[["nta1_w1f"]] <- nta1_w1f
rm(nta1_w1f)


#cases with only one treatment that has ended in wave 2
nta1_w2f <- nt %>% filter(is.na(RCinter1)==T & 
                         is.na(RCinter2)==F &
                         is.na(RCinter3)==T &
                         Q_time > eRC_Time2)
#remove these cases from nt
nt <- nt %>% anti_join(nta1_w2f)
#get new columne for subgroup
nta1_w2f$TG <- 3 #numeric var for treat group
nta1_w2f$TG_name <- "ntaft" #abbrevation frour group
nta1_w2f$TG_time <-  nta1_w2f$eRC_Time2#start of beeing in that group
#save in list
nta1[["nta1_w3f"]] <- nta1_w2f
rm(nta1_w2f)

#cases with only one treatment that has ended in wave 3
nta1_w3f <- nt %>% filter(is.na(RCinter1)==T & 
                         is.na(RCinter2)==T &
                         is.na(RCinter3)==F &
                         Q_time > eRC_Time3)
#remove these cases from nt
nt <- nt %>% anti_join(nta1_w3f)
#get new columne for subgroup
nta1_w3f$TG <- 3 #numeric var for treat group
nta1_w3f$TG_name <- "ntaft" #abbrevation frour group
nta1_w3f$TG_time <-  nta1_w3f$eRC_Time3#start of beeing in that group
#save in list
nta1[["nta1_w3f"]] <- nta1_w3f
rm(nta1_w3f)



#no treatment any more after st
nta2_w2 <- nt %>% filter(is.na(RCinter1)==F & 
                         reRCt1 == "gekippt" &
                         is.na(RCinter2)==F &
                         Q_time > eRC_Time2)
#remove these cases from nt
nt <- nt %>% anti_join(nta2_w2)
#get new columne for subgroup
nta2_w2$TG <- 4 #numeric var for treat group
nta2_w2$TG_name <- "ntast" #abbrevation frour group
nta2_w2$TG_time <-  nta2_w2$eRC_Time2#start of beeing in that group
#save in list
nta2[["nta2_w2"]] <- nta2_w2
rm(nta2_w2)


rm(nt)
#more cases are possible but arent in the data: as for example ntast after wave 3 or ntast after second treatment after long first treatment
#this can be conntrolled as while writing the code nt ore trt is studyed


#bind all cases again, but before change data format as in no treatment to character
ft <- rbindlist(ft)
ft$TG_time <- as.character(ft$TG_time)
trt_grp[["ft"]] <- ft

st <- rbindlist(st)
st$TG_time <- as.character(st$TG_time)
trt_grp[["st"]] <- st

nta1 <- rbindlist(nta1)
nta1$TG_time <- as.character(nta1$TG_time)
trt_grp[["nta1"]] <- nta1


nta2 <- rbindlist(nta2)
nta2$TG_time <- as.character(nta2$TG_time)
trt_grp[["nta2"]] <- nta2


trt_grp[["nty"]] <- rbindlist(nty)
rm(ft,st,nta1,nta2,nty)

rd <- rbindlist(trt_grp)#tg_time muss als character gespeichert werden 
rm(trt_grp)




#breinigen von time ft$treat_G <- gsub("_","",ft$ft) #uneven number therfore remove
#ft$treat_G <- gsub("\\s{1,}","",ft$treat_G)#no more whitspace
#ft$treat_G <- gsub("-","_",ft$treat_G)#no more "

```






```{r}
rd <- rd%>%select(gid2015,
             city_name,
             Bundesland,
             Verwaltungseinheit,
             jahr,
             Q_time,
             RC,
             n_adtc,
             c_inv,
             c_no_inv,
             c_high_priced_inv,
             c_medium_priced_inv,
             c_low_priced_inv,
             c_high_priced_no_inv,
             c_medium_priced_no_inv,
             c_low_priced_no_inv,
             ob_zu,
             n_adtc_obzu,
             n_nei_high_priced,
             n_nei_medium_priced,
             n_nei_low_priced,
             n_nei_NA,
             TG,
             TG_name,
             TG_time)



```




```{r}


###------------####
#Ratios of for comparability between citys



#####Ratios of investment to the city

#R_inv
#ratio of flats is which money was invested in the last Q_time
#change nas in c_inv to zero
rd$c_inv[is.na(rd$c_inv)] <- 0 

rd$R_inv_tc <- rd$c_inv/rd$n_adtc


#R_inv_hp_city
#ratio of flats with investment that are located in high priced neigberhood
#to all flats in the city
rd$R_inv_hp_city <- rd$c_high_priced_inv /rd$n_adtc

#R_inv_mp_city
#ratio of flats with investment that are located in medium priced neigberhood
#to all flats in the city
rd$R_inv_mp_city <- rd$c_medium_priced_inv /rd$n_adtc

#R_inv_lp_city
#ratio of flats with investment that are located in low priced neigberhood
#to all flats in the city
rd$R_inv_lp_city <- rd$c_low_priced_inv /rd$n_adtc





########ratios to all flats with investment 

#R_inv_hp
#ratio of flats with investment that are located in high priced neigberhood
#to all flats with investment
rd$R_inv_hp <- rd$c_high_priced_inv /rd$c_inv

#R_inv_mp
#ratio of flats with investment that are located in medium priced neigberhood
#to all flats with investment
rd$R_inv_mp <- rd$c_medium_priced_inv /rd$c_inv

#R_inv_lp
#ratio of flats with investment that are located in low priced neigberhood
#to all flats with investment
rd$R_inv_lp <- rd$c_low_priced_inv /rd$c_inv






###ratios of objekzustand

###in the city
#bsp. anteil modernisierter wohnugen ind er stadt
#ratio of objektzustand overall
rd$R_obzu <- rd$n_adtc_obzu/rd$n_adtc


#Bsp. anteil der Modernisierten Wohnungen in teuern vierteln zu allen Wohnugen
#gives information about the mix of flats in a district
#ratio of flats in priceclassx korrektet for the overall number of flats in that priceclass
#interpretaion in priceclass x the rc leeds to more or less y (renovations for example)
# looks a little bit confusion because long format, each row is a objectcondition
#R_obzu_nh_hp_city
#ratio with a objektzustand in high priced neigberhood to all flats in a city
rd$R_obzu_nh_hp_city <- rd$n_nei_high_priced/rd$n_adtc

#R_obzu_nh_mp_city
#ratio with a objektzustand in medium priced neigberhood to all flats in a city
rd$R_obzu_nh_mp_city <- rd$n_nei_medium_priced/rd$n_adtc

#R_obzu_nh_lp_city
#ratio with a objektzustand in medium priced neigberhood to all flats in a city
rd$R_obzu_nh_lp_city <- rd$n_nei_low_priced/rd$n_adtc




#anteil moderniserter wohnungen die in niedrig teurem oderm günstiger lage liegen
##ratios of district price to flats with the same obzu
#R_obzu_nh_hp
#ratio with a objektzustand in high priced neigberhood to all flats with the same obzu
#interperetaion wher are the most renovated flats in comparison to all flats in that condition
rd$R_obzu_nh_hp <- rd$n_nei_high_priced/rd$n_adtc_obzu

#R_obzu_nh_mp
#ratio with a objektzustand in medium priced neigberhood to all with the same obzu
rd$R_obzu_nh_mp <- rd$n_nei_medium_priced/rd$n_adtc_obzu

#R_obzu_nh_lp
#ratio with a objektzustand in medium priced neigberhood to all with the same obzu
rd$R_obzu_nh_lp <- rd$n_nei_low_priced/rd$n_adtc_obzu



##### get wide form of data set

rd <- rd %>%
  pivot_wider(names_from = ob_zu,
              values_from = c(n_adtc_obzu,
                              R_obzu,
                              R_obzu_nh_hp,
                              R_obzu_nh_hp_city,
                              R_obzu_nh_mp,
                              R_obzu_nh_mp_city,
                              R_obzu_nh_lp,
                              R_obzu_nh_lp_city,
                              n_nei_low_priced,
                              n_nei_medium_priced,
                              n_nei_high_priced,
                              n_nei_NA))







#####save unbalenced panel data
fwrite(rd,
       file = here("data/raw/rd1.csv"), 
       sep = ",")



```


```{r}
#get time periodes for the did package 



setDT(rd)[, t_month := format(as.Date(Q_time), "%m") ]
setDT(rd)[, t_year := format(as.Date(Q_time), "%Y") ]
rd$t_month <- as.numeric(rd$t_month)
rd$t_year <- as.numeric(rd$t_year)  #hier das selbe problem jahre nicht rrichti extrahiert

t_min_year <- min(rd$t_year) 
rd$t_year <- (rd$t_year - t_min_year)*12 #years in month

#time periodes starting with the first observation
rd$t_periode <- rd$t_year + rd$t_month





#####das ganze für die gruppen wiederholen
#also treat_g erst bereinigen und dann zu periode umwandeln

rd$TG_periode <- rd$TG_time


rd$TG_periode[rd$TG_periode == ""] <- "2007-01-01" #startpunkt erhebung ==0
rd$TG_periode <- as.Date(rd$TG_periode)


setDT(rd)[, tg_month := format(as.Date(TG_periode), "%m") ]
setDT(rd)[, tg_year := format(as.Date(TG_periode), "%Y") ] 
rd$tg_month <- as.numeric(rd$tg_month)
rd$tg_year <- as.numeric(rd$tg_year)

tg_min_year <- min(rd$t_year) 
rd$tg_year <- (rd$tg_year - t_min_year)*12 #years in month


#time periodes starting with the first observation
rd$TG_periode <- rd$tg_year + rd$tg_month

# korrekt the no_treatment group, "2007-01-01" gives TG_periode 1
rd$TG_periode[rd$TG_periode == 1] <- 0



```





```{r}

#get gid of citys with group and start periode
ft <- rd[TG == 1]
st <- rd[TG == 2]
ntaft <- rd[TG == 3]
ntast <- rd[TG == 4]


ft <- ft[,c("gid2015","TG_periode")]
st <- st[,c("gid2015","TG_periode")]
ntaft <- ntaft[,c("gid2015","TG_periode")]
ntast <- ntast[,c("gid2015","TG_periode")]

ft <- unique(ft)
st <- unique(st)
ntaft <- unique(ntaft)
ntast <- unique(ntast)

#data frames with group specific treatment times and gid numbers
setnames(ft, "TG_periode", "ft_periode")
setnames(st, "TG_periode", "st_periode")
setnames(ntaft, "TG_periode", "nta1_periode")
setnames(ntast, "TG_periode", "nta2_periode")

#merge the created group timme variables with the gid with the original data
rd[ft, ft_periode:=ft_periode, on=c("gid2015")]
rd$ft_periode[is.na(rd$ft_periode) == T] <- 0

rd[st, st_periode:=st_periode, on=c("gid2015")]
rd$st_periode[is.na(rd$st_periode) == T] <- 0

rd[ntaft, nta1_periode:=nta1_periode , on=c("gid2015")] 
rd$nta1_periode[is.na(rd$nta1_periode) == T] <- 0

rd[ntast, nta2_periode:=nta2_periode, on=c("gid2015")] 
rd$nta2_periode[is.na(rd$nta2_periode) == T] <- 0

#rm(ft,st,ntaft,ntast)
rm(ft,ntaft,ntast,st)
gc()

```




```{r}
#fwrite(rd,
 #      file = here("data/raw/rd2.csv"), 
  #     sep = ",")

#import rd
rd <- fread(here("data/raw/rd2.csv"),
                sep = ",",
                dec = ".",
            encoding = "UTF-8"
            )
```




```{r inka controll variables}

#match the gid
#the gid from the gdp are the first 5 numbers 
#so grep first 4 digits of gid2015, generate new columne and merge on that one



#get leading zeros for the gid numbers to match the patttern extracter 
rd$gid2015 <- with_options(
                       c(scipen = 999), 
                       str_pad(rd$gid2015, 8, pad = "0")
   )



rd$g5 <- str_extract(rd$gid2015, "^\\d{5}")
rd$g5 <- as.character(rd$g5)

#import data from inka
inka <- fread(here("~/rent_control/data/raw/inkar(1).csv"),
              header = T)


inka$Kennziffer <- with_options(
                       c(scipen = 999), 
                       str_pad(inka$Kennziffer, 5, pad = "0")
   )






R_debt_i <- inka[,1:19]
colnames(R_debt_i) <- as.character(R_debt_i[1,])
names(R_debt_i)[2] <- "Stadt"
names(R_debt_i)[1] <- "g5"
R_debt_i <- R_debt_i[-1,]
#wide to long format with tidyr, pivot longer doestn work...
R_debt_i <- gather(R_debt_i, year, Schuldnerquote, 4:19, factor_key=TRUE)
names(R_debt_i)[4] <- "jahr"
#remove the subdata from inka dataset
inka <- inka[,-(4:19)]
#same format as in rd
R_debt_i$g5 <- as.character(R_debt_i$g5)
#merge
R_debt_i$jahr <- as.numeric(as.character(R_debt_i$jahr))
rd[R_debt_i, Schuldnerquote:=Schuldnerquote, on=c("g5", "jahr")]




#Haushaltseinkommen


hh_inc <- inka[,1:23]
colnames(hh_inc) <- as.character(hh_inc[1,])
names(hh_inc)[2] <- "Stadt"
names(hh_inc)[1] <- "g5"
hh_inc <- hh_inc[-1,]
#wide to long format with tidyr, pivot longer doestn work...
hh_inc <- gather(hh_inc, year, hh_inc, 4:23, factor_key=TRUE)
names(hh_inc)[4] <- "jahr"
#remove the subdata from inka dataset
inka <- inka[,-(4:23)]
#same format as in rd
hh_inc$g5 <- as.character(hh_inc$g5)
#merge
hh_inc$jahr <- as.numeric(as.character(hh_inc$jahr))
rd[hh_inc, hh_inc:=hh_inc, on=c("g5","jahr")]


#Mietzuschuss


rent_sub <- inka[,1:28]
colnames(rent_sub) <- as.character(rent_sub[1,])
names(rent_sub)[2] <- "Stadt"
names(rent_sub)[1] <- "g5"
rent_sub <- rent_sub[-1,]
#wide to long format with tidyr, pivot longer doestn work...
rent_sub <- gather(rent_sub, year, rent_sub, 4:28, factor_key=TRUE)
names(rent_sub)[4] <- "jahr"
#remove the subdata from inka dataset
inka <- inka[,-(4:28)]
#same format as in rd
rent_sub$g5 <- as.character(rent_sub$g5)
#merge
rent_sub$jahr <- as.numeric(as.character(rent_sub$jahr))
rd[rent_sub, rent_sub:=rent_sub, on=c("g5", "jahr")]


#GDP


gdp <- inka[,1:23]
colnames(gdp) <- as.character(gdp[1,])
names(gdp)[2] <- "Stadt"
names(gdp)[1] <- "g5"
gdp <- gdp[-1,]
#wide to long format with tidyr, pivot longer doestn work...
gdp <- gather(gdp, year, gdp, 4:23, factor_key=TRUE)
names(gdp)[4] <- "jahr"
#remove the subdata from inka dataset
inka <- inka[,-(4:23)]
#same format as in rd
gdp$g5 <- as.character(gdp$g5)
#merge
gdp$jahr <- as.numeric(as.character(gdp$jahr))
rd[gdp, gdp:=gdp, on=c("g5", "jahr")]


#Population



#Population
pop <- inka[,1:28]
colnames(pop) <- as.character(pop[1,])
names(pop)[2] <- "Stadt"
names(pop)[1] <- "g5"
pop <- pop[-1,]
#wide to long format with tidyr, pivot longer doestn work...
pop <- gather(pop, year, pop, 4:28, factor_key=TRUE)
names(pop)[4] <- "jahr"
#remove the subdata from inka dataset
inka <- inka[,-(4:28)]
#same format as in rd
pop$g5 <- as.character(pop$g5)
#merge
pop$jahr <- as.numeric(as.character(pop$jahr))
rd[pop, pop:=pop, on=c("g5","jahr")]





#Erwerbsquote

emp <- inka[,1:25]
colnames(emp) <- as.character(emp[1,])
names(emp)[2] <- "Stadt"
names(emp)[1] <- "g5"
emp <- emp[-1,]
#wide to long format with tidyr, pivot longer doestn work...
emp <- gather(emp, year, employment, 4:25, factor_key=TRUE)
names(emp)[4] <- "jahr"
#remove the subdata from inka dataset
inka <- inka[,-(4:25)]
#same format as in rd
emp$g5 <- as.character(emp$g5)
#merge
emp$jahr <- as.numeric(as.character(emp$jahr))
rd[emp, employment:=employment, on=c("g5","jahr")]


#students
stud <- inka[,1:28]
colnames(stud) <- as.character(stud[1,])
names(stud)[2] <- "Stadt"
names(stud)[1] <- "g5"
stud <- stud[-1,]
#wide to long format with tidyr, pivot longer doestn work...
stud <- gather(stud, year, stud, 4:28, factor_key=TRUE)
names(stud)[4] <- "jahr"
#remove the subdata from inka dataset
inka <- inka[,-(4:28)]
#same format as in rd
stud$g5 <- as.character(stud$g5)
#merge
stud$jahr <- as.numeric(as.character(stud$jahr))
rd[stud, stud:=stud, on=c("g5","jahr")]


#sgb-ii quote
sgb <- inka[,1:14]
colnames(sgb) <- as.character(sgb[1,])
names(sgb)[2] <- "Stadt"
names(sgb)[1] <- "g5"
sgb <- sgb[-1,]
#wide to long format with tidyr, pivot longer doestn work...
sgb <- gather(sgb, year, sgb, 4:14, factor_key=TRUE)
names(sgb)[4] <- "jahr"
#remove the subdata from inka dataset
inka <- inka[,-(4:14)]
#same format as in rd
sgb$g5 <- as.character(sgb$g5)
#merge
sgb$jahr <- as.numeric(as.character(sgb$jahr))
rd[sgb, sgb:=sgb, on=c("g5","jahr")]


#gdp by population
gdppp <- inka[,1:22]
colnames(gdppp) <- as.character(gdppp[1,])
names(gdppp)[2] <- "Stadt"
names(gdppp)[1] <- "g5"
gdppp <- gdppp[-1,]
#wide to long format with tidyr, pivot longer doestn work...
gdppp <- gather(gdppp, year, gdppp, 4:22, factor_key=TRUE)
names(gdppp)[4] <- "jahr"
#remove the subdata from inka dataset
inka <- inka[,-(4:22)]
#same format as in rd
gdppp$g5 <- as.character(gdppp$g5)
#merge
gdppp$jahr <- as.numeric(as.character(gdppp$jahr))
rd[gdppp, gdppp:=gdppp, on=c("g5","jahr")]


#Fertiggestellte Wohngebaeude mit erneuerbarer Heizenergie
eng <- inka[,1:7]
colnames(eng) <- as.character(eng[1,])
names(eng)[2] <- "Stadt"
names(eng)[1] <- "g5"
eng <- eng[-1,]
#wide to long format with tidyr, pivot longer doestn work...
eng <- gather(eng, year, eng, 4:7, factor_key=TRUE)
names(eng)[4] <- "jahr"
#remove the subdata from inka dataset
inka <- inka[,-(4:7)]
#same format as in rd
eng$g5 <- as.character(eng$g5)
#merge
eng$jahr <- as.numeric(as.character(eng$jahr))
rd[eng, eng:=eng, on=c("g5","jahr")]





#import data from inka for population density
pop_den <- fread(here("~/rent_control/data/raw/population_density_inkar.csv"),
              header = T,
              encoding = "UTF-8")


pop_den$Kennziffer <- with_options(
                       c(scipen = 999), 
                       str_pad(pop_den$Kennziffer, 5, pad = "0")
   )

colnames(pop_den) <- as.character(pop_den[1,])
names(pop_den)[2] <- "Stadt"
names(pop_den)[1] <- "g5"
pop_den <- pop_den[-1,]
#wide to long format with tidyr, pivot longer doestn work...
pop_den <- gather(pop_den, year, pop_den, 4:18, factor_key=TRUE)
names(pop_den)[4] <- "jahr"

#same format as in rd
pop_den$g5 <- as.character(pop_den$g5)
#merge
pop_den$jahr <- as.numeric(as.character(pop_den$jahr))

rd[pop_den, pop_den:=pop_den, on=c("g5","jahr")]

#clean environment
rm(emp,eng,gdp,gdppp,hh_inc,inka,pop,R_debt_i,rent_sub,sgb,stud, pop_den)
gc()

```






```{r}
#data with a least 10 >= observations at a month (min. 10 >=n_adtc)

m10_rd <- rd%>% filter(rd$n_adtc >= 10)


#####save unbalenced panel data with at least 20 observation per panel observation
fwrite(m10_rd,
       file = here("data/raw/m10_rd.csv"), 
       sep = ",")


```








```{r}
##loop for every variable with lgdp




#controll vars
#comma to point
m10_rd$gdp <- as.numeric(gsub(",", ".", m10_rd$gdp))
m10_rd$gdppp <- as.numeric(gsub(",", ".", m10_rd$gdppp))
m10_rd$Schuldnerquote <- as.numeric(gsub(",", ".", m10_rd$Schuldnerquote))
m10_rd$pop <- as.numeric(gsub(",", ".", m10_rd$pop))
m10_rd$stud <- as.numeric(gsub(",", ".", m10_rd$stud))
m10_rd$rent_sub <- as.numeric(gsub(",", ".", m10_rd$rent_sub))
m10_rd$pop_den <- as.numeric(gsub(",", ".", m10_rd$pop_den))
m10_rd$sgb <- as.numeric(gsub(",", ".", m10_rd$sgb))

#log transform
m10_rd$lgdp <-  log(m10_rd$gdp)
m10_rd$lgdppp <- log(m10_rd$gdppp)
m10_rd$lpop <- log(m10_rd$pop)
m10_rd$lstud <- log(m10_rd$stud)
m10_rd$lpop_den <- log(m10_rd$pop_den)

#ratios log
m10_rd$log_inv_hp_city <- log(m10_rd$R_inv_hp_city)
m10_rd$log_inv_mp_city <- log(m10_rd$R_inv_mp_city)
m10_rd$log_inv_lp_city <- log(m10_rd$R_inv_lp_city)
m10_rd$log_inv_tc <- log(m10_rd$R_inv_tc)
            

#"R_obzu_Abbruchreif",
m10_rd$log_Abbruchreif <- log(m10_rd$R_obzu_Abbruchreif)
m10_rd$log_Abbruchreif_lp_nh_city <- log(m10_rd$R_obzu_nh_lp_city_Abbruchreif)
m10_rd$log_Abbruchreif_mp_nh_city <- log(m10_rd$R_obzu_nh_mp_city_Abbruchreif)
m10_rd$log_Abbruchreif_hp_nh_city <- log(m10_rd$R_obzu_nh_hp_city_Abbruchreif)

#"R_obzu_Erstbezug",
m10_rd$log_Erstbezug <- log(m10_rd$R_obzu_Erstbezug)
m10_rd$log_Erstbezug_lp_nh_city <- log(m10_rd$R_obzu_nh_lp_city_Erstbezug)
m10_rd$log_Erstbezug_mp_nh_city <- log(m10_rd$R_obzu_nh_mp_city_Erstbezug)
m10_rd$log_Erstbezug_hp_nh_city <- log(m10_rd$R_obzu_nh_hp_city_Erstbezug)

#Erstbezug_nach_Sanierung
m10_rd$log_Erstbezug_nach_Sanierung <- log(m10_rd$R_obzu_Erstbezug_nach_Sanierung)
m10_rd$log_Erstbezug_nach_Sanierung_lp_nh_city <- log(m10_rd$R_obzu_nh_lp_city_Erstbezug_nach_Sanierung)
m10_rd$log_Erstbezug_nach_Sanierung_mp_nh_city <- log(m10_rd$R_obzu_nh_mp_city_Erstbezug_nach_Sanierung)
m10_rd$log_Erstbezug_nach_Sanierung_hp_nh_city <- log(m10_rd$R_obzu_nh_hp_city_Erstbezug_nach_Sanierung)

#"R_obzu_Gepflegt",
m10_rd$log_Gepflegt <- log(m10_rd$R_obzu_Gepflegt)
m10_rd$log_Gepflegt_lp_nh_city <- log(m10_rd$R_obzu_nh_lp_city_Gepflegt)
m10_rd$log_Gepflegt_mp_nh_city <- log(m10_rd$R_obzu_nh_mp_city_Gepflegt)
m10_rd$log_Gepflegt_hp_nh_city <- log(m10_rd$R_obzu_nh_hp_city_Gepflegt)

#Modernisiert
m10_rd$log_Modernisiert <- log(m10_rd$R_obzu_Modernisiert)
m10_rd$log_Modernisiert_lp_nh_city <- log(m10_rd$R_obzu_nh_lp_city_Modernisiert)
m10_rd$log_Modernisiert_mp_nh_city <- log(m10_rd$R_obzu_nh_mp_city_Modernisiert)
m10_rd$log_Modernisiert_hp_nh_city <- log(m10_rd$R_obzu_nh_hp_city_Modernisiert)

#"R_obzu_Nach_Vereinbarung",
m10_rd$log_Nach_Vereinbarung <- log(m10_rd$R_obzu_Nach_Vereinbarung)
m10_rd$log_Nach_Vereinbarung_lp_nh_city <- log(m10_rd$R_obzu_nh_lp_city_Nach_Vereinbarung)
m10_rd$log_Nach_Vereinbarung_mp_nh_city <- log(m10_rd$R_obzu_nh_mp_city_Nach_Vereinbarung)
m10_rd$log_Nach_Vereinbarung_hp_nh_city <- log(m10_rd$R_obzu_nh_hp_city_Nach_Vereinbarung)

#"R_obzu_Neuwertig",
m10_rd$log_Neuwertig <- log(m10_rd$R_obzu_Neuwertig)
m10_rd$log_Neuwertig_lp_nh_city <- log(m10_rd$R_obzu_nh_lp_city_Neuwertig)
m10_rd$log_Neuwertig_mp_nh_city <- log(m10_rd$R_obzu_nh_mp_city_Neuwertig)
m10_rd$log_Neuwertig_hp_nh_city <- log(m10_rd$R_obzu_nh_hp_city_Neuwertig)

#renovierungsbeduerftig
m10_rd$log_Renovierungsbeduerftig <- log(m10_rd$R_obzu_Renovierungsbeduerftig)
m10_rd$log_Renovierungsbeduerftig_lp_nh_city <- log(m10_rd$R_obzu_nh_lp_city_Renovierungsbeduerftig)
m10_rd$log_Renovierungsbeduerftig_mp_nh_city <- log(m10_rd$R_obzu_nh_mp_city_Renovierungsbeduerftig)
m10_rd$log_Renovierungsbeduerftig_hp_nh_city <- log(m10_rd$R_obzu_nh_hp_city_Renovierungsbeduerftig)

#saniert
m10_rd$log_saniert <- log(m10_rd$R_obzu_Saniert)
m10_rd$log_saniert_lp_nh_city <- log(m10_rd$R_obzu_nh_lp_city_Saniert)
m10_rd$log_saniert_mp_nh_city <- log(m10_rd$R_obzu_nh_mp_city_Saniert)
m10_rd$log_saniert_hp_nh_city <- log(m10_rd$R_obzu_nh_hp_city_Saniert)

#"R_obzu_Vollstaendig_Renoviert",
m10_rd$log_Vollstaendig_Renoviert <- log(m10_rd$R_obzu_Vollstaendig_Renoviert)
m10_rd$log_Vollstaendig_Renoviert_lp_nh_city <- log(m10_rd$R_obzu_nh_lp_city_Vollstaendig_Renoviert)
m10_rd$log_Vollstaendig_Renoviert_mp_nh_city <- log(m10_rd$R_obzu_nh_mp_city_Vollstaendig_Renoviert)
m10_rd$log_Vollstaendig_Renoviert_hp_nh_city <- log(m10_rd$R_obzu_nh_hp_city_Vollstaendig_Renoviert)

#"R_obzu_Unbekannter_Zustand",
m10_rd$log_Unbekannter_Zustand <- log(m10_rd$R_obzu_Unbekannter_Zustand)
m10_rd$log_Unbekannter_Zustand_lp_nh_city <- log(m10_rd$R_obzu_nh_lp_city_Unbekannter_Zustand)
m10_rd$log_Unbekannter_Zustand_mp_nh_city <- log(m10_rd$R_obzu_nh_mp_city_Unbekannter_Zustand)
m10_rd$log_Unbekannter_Zustand_hp_nh_city <- log(m10_rd$R_obzu_nh_hp_city_Unbekannter_Zustand)



#remove infinite values from m10_rd
m10_rd <- m10_rd %>% mutate_if(is.numeric, list(~na_if(., Inf))) %>% 
  mutate_if(is.numeric, list(~na_if(., -Inf)))



#kick TG=4 not enough cases




fwrite(m10_rd,
       file = here("data/tidy/m10_rd.csv"), 
       sep = ",")




m10_rd3 <- m10_rd %>% filter(TG != 4)

fwrite(m10_rd3,
       file = here("data/tidy/m10_rd3.csv"), 
       sep = ",")
rm(m10_rd3)

```

 
 
 
#####from here on only import the complete data set

```{r}
#import rd
m10_rd <- fread(here("data/tidy/m10_rd3.csv"),
                sep = ",",
                dec = ".",
            encoding = "UTF-8"
            )




```

 

 
 
 
 
 
 
#robustness variables
#north / south 
#süd nord gefälle

```{r}
m10_rd <- m10_rd%>%
  mutate( north =
    case_when(Bundesland == "Berlin" ~ "north",
              Bundesland == "Brandenburg" ~ "north",
              Bundesland == "Bremen" ~ "north",
              Bundesland == "Hamburg" ~ "north",
              Bundesland == "Mecklenburg-Vorpommern" ~ "north",
              Bundesland == "Niedersachsen" ~ "north",
              Bundesland == "Nordrhein-Westfalen" ~ "north",
              Bundesland == "Sachsen-Anhalt" ~ "north",
              Bundesland == "Schleswig-Holstein" ~ "north"
              )
  )


m10_rd <- m10_rd%>%
  mutate( south =
    case_when(Bundesland == "Baden-Württemberg" ~ "south",
              Bundesland == "Bayern" ~ "south",
              Bundesland == "Hessen" ~ "south",
              Bundesland == "Saarland" ~ "south",
              Bundesland == "Sachsen" ~ "south",
              Bundesland == "Thüringen" ~ "south",
              Bundesland == "Rheinland-Pfalz"~ "south",
              )
  )


```






#####################################################################################################################################################
## staggered Difference in Difference Model
##################################################################################################################################################### 








#filtered data sets for the different comparisons
```{r}



#control group: no rent control; treatment group: rent control first time
nrft <- m10_rd %>% filter(TG==1 | TG==0) 

#control group: rent control first time; treatment group: repealed rent control
ftrr <- m10_rd %>% filter(TG==1 | TG==3) 

#control group: repealed rent control; treatment group: rent control second time
rrst <- m10_rd %>% filter(TG==3 | TG==2) 


```











#
down below are all models 

each one gets saved in ints one list in a list 

######################
models for every controll var
```{r}


log_ratios <- c(
#overall investment
"log_inv_hp_city" ,
"log_inv_mp_city", 
"log_inv_lp_city",
"log_inv_tc",
  
#"R_obzu_Abbruchreif",
"log_Abbruchreif",
"log_Abbruchreif_lp_nh_city",
"log_Abbruchreif_mp_nh_city",
"log_Abbruchreif_hp_nh_city",

#"R_obzu_Erstbezug",
"log_Erstbezug",
"log_Erstbezug_lp_nh_city" ,
"log_Erstbezug_mp_nh_city",
"log_Erstbezug_hp_nh_city",

#Erstbezug_nach_Sanierung
"log_Erstbezug_nach_Sanierung",
"log_Erstbezug_nach_Sanierung_lp_nh_city",
"log_Erstbezug_nach_Sanierung_mp_nh_city",
"log_Erstbezug_nach_Sanierung_hp_nh_city",

#"R_obzu_Gepflegt",
"log_Gepflegt",
"log_Gepflegt_lp_nh_city",
"log_Gepflegt_mp_nh_city" ,
"log_Gepflegt_hp_nh_city" ,

#Modernisiert
"log_Modernisiert",
"log_Modernisiert_lp_nh_city",
"log_Modernisiert_mp_nh_city" ,
"log_Modernisiert_hp_nh_city",

#"R_obzu_Nach_Vereinbarung",
"log_Nach_Vereinbarung",
"log_Nach_Vereinbarung_lp_nh_city",
"log_Nach_Vereinbarung_mp_nh_city",
"log_Nach_Vereinbarung_hp_nh_city",

#"R_obzu_Neuwertig",
"log_Neuwertig",
"log_Neuwertig_lp_nh_city",
"log_Neuwertig_mp_nh_city",
"log_Neuwertig_hp_nh_city",

#renovierungsbeduerftig
"log_Renovierungsbeduerftig",
"log_Renovierungsbeduerftig_lp_nh_city",
"log_Renovierungsbeduerftig_mp_nh_city",
"log_Renovierungsbeduerftig_hp_nh_city",

#saniert
"log_saniert",
"log_saniert_lp_nh_city",
"log_saniert_mp_nh_city",
"log_saniert_hp_nh_city",

#"R_obzu_Vollstaendig_Renoviert",
"log_Vollstaendig_Renoviert",
"log_Vollstaendig_Renoviert_lp_nh_city",
"log_Vollstaendig_Renoviert_mp_nh_city",
"log_Vollstaendig_Renoviert_hp_nh_city",

#"R_obzu_Unbekannter_Zustand",
"log_Unbekannter_Zustand",
"log_Unbekannter_Zustand_lp_nh_city",
"log_Unbekannter_Zustand_mp_nh_city",
"log_Unbekannter_Zustand_hp_nh_city"
)

C1G_reg <- list()
C1E_reg <- list()

C2G_reg <- list()
C2E_reg <- list()

C3G_reg <- list()
C3E_reg <- list()
```


##nrft

#models for each controll variable
```{r warning=FALSE}


#lgdppp
###################
c1_g <- list()
c1_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c1 <- att_gt(yname = log_inv_hp_city, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "ft_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~lgdppp,#assen
              data = nrft, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c1,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c1,
            type = "dynamic",
            na.rm = T)

#save event study
c1_e[[j]] <- es

#get plot
did_plot_g <- ggdid(gp)

#did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in #quality")) +
 # scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c1_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C1G_reg[["lgdppp"]] <- c1_g
C1E_reg[["lgdppp"]] <- c1_e

```


#lpop
```{r warning=FALSE}


#lpop
###################
c1_g <- list()
c1_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c1 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "ft_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~lpop,#assen
              data = nrft, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c1,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c1,
            type = "dynamic",
            na.rm = T)

#save event study
c1_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c1_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C1G_reg[["lpop"]] <- c1_g
C1E_reg[["lpop"]] <- c1_e

```

#lpop_den
```{r warning=FALSE}


#lpopden
###################
c1_g <- list()
c1_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c1 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "ft_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~lpop_den,#assen
              data = nrft, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c1,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c1,
            type = "dynamic",
            na.rm = T)

#save event study
c1_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c1_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C1G_reg[["lpop_den"]] <- c1_g
C1E_reg[["lpop_den"]] <- c1_e

```


#rent_sub
```{r warning=FALSE}


#rent_sub
###################
c1_g <- list()
c1_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c1 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "ft_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~rent_sub,#assen
              data = nrft, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c1,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c1,
            type = "dynamic",
            na.rm = T)

#save event study
c1_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c1_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C1G_reg[["rent_sub"]] <- c1_g
C1E_reg[["rent_sub"]] <- c1_e

```

#schuldnerquote
```{r warning=FALSE}


#schuldnerquote
###################
c1_g <- list()
c1_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c1 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "ft_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~Schuldnerquote,#assen
              data = nrft, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c1,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c1,
            type = "dynamic",
            na.rm = T)

#save event study
c1_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c1_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C1G_reg[["schuldnerquote"]] <- c1_g
C1E_reg[["schuldnerquote"]] <- c1_e

```

#sgb
```{r warning=FALSE}


#sgb
###################
c1_g <- list()
c1_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c1 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "ft_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~sgb,#assen
              data = nrft, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c1,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c1,
            type = "dynamic",
            na.rm = T)

#save event study
c1_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c1_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C1G_reg[["sgb"]] <- c1_g
C1E_reg[["sgb"]] <- c1_e

```


#null
```{r warning=FALSE}


#NULL
###################
c1_g <- list()
c1_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c1 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "ft_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =NULL,#assen
              data = nrft, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c1,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c1,
            type = "dynamic",
            na.rm = T)

#save event study
c1_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c1_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C1G_reg[["keine"]] <- c1_g
C1E_reg[["keine"]] <- c1_e

list.save(C1E_reg, here("output/c1/C1E_reg.rds"))
list.save(C1G_reg, here("output/c1/C1G_reg.rds"))
```



 
#######ftrr
#models for each controll variable
```{r warning=FALSE}


#lgdppp
###################
c2_g <- list()
c2_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c2 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "nta1_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~lgdppp,#assen
              data = ftrr, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c2,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c2,
            type = "dynamic",
            na.rm = T)

#save event study
c2_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c2_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C2G_reg[["lgdppp"]] <- c2_g
C2E_reg[["lgdppp"]] <- c2_e

```


#lpop
```{r warning=FALSE}


#lpop
###################
c2_g <- list()
c2_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c2 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "nta1_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~lpop,#assen
              data = ftrr, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c2,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c2,
            type = "dynamic",
            na.rm = T)

#save event study
c2_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c2_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C2G_reg[["lpop"]] <- c2_g
C2E_reg[["lpop"]] <- c2_e

```

#lpop_den
```{r warning=FALSE}


#lpopden
###################
c2_g <- list()
c2_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c2 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "nta1_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~lpop_den,#assen
              data = ftrr, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c2,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c2,
            type = "dynamic",
            na.rm = T)

#save event study
c2_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c2_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C2G_reg[["lpop_den"]] <- c2_g
C2E_reg[["lpop_den"]] <- c2_e

```


#rent_sub
```{r warning=FALSE}


#rent_sub
###################
c2_g <- list()
c2_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c2 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "nta1_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~rent_sub,#assen
              data = ftrr, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c2,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c2,
            type = "dynamic",
            na.rm = T)

#save event study
c2_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c2_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C2G_reg[["rent_sub"]] <- c2_g
C2E_reg[["rent_sub"]] <- c2_e

```

#schuldnerquote
```{r warning=FALSE}


#schuldnerquote
###################
c2_g <- list()
c2_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c2 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "nta1_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~Schuldnerquote,#assen
              data = ftrr, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c2,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c2,
            type = "dynamic",
            na.rm = T)

#save event study
c2_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c2_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C2G_reg[["schuldnerquote"]] <- c2_g
C2E_reg[["schuldnerquote"]] <- c2_e

```

#sgb
```{r warning=FALSE}


#sgb
###################
c2_g <- list()
c2_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c2 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "nta1_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~sgb,#assen
              data = ftrr, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c2,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c2,
            type = "dynamic",
            na.rm = T)

#save event study
c2_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c2_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C2G_reg[["sgb"]] <- c2_g
C2E_reg[["sgb"]] <- c2_e

```


#null
```{r warning=FALSE}


#NULL
###################
c2_g <- list()
c2_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c2 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "nta1_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =NULL,#assen
              data = ftrr, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c2,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c2,
            type = "dynamic",
            na.rm = T)

#save event study
c2_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c2_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}

C2E_reg[["keine"]] <- c2_e
C2G_reg[["keine"]] <- c2_g

list.save(C2E_reg, here("output/c2/C2E_reg.rds"))
list.save(C2G_reg, here("output/c2/C2G_reg.rds"))
```


#rrst

#######ftrr
#models for each controll variable
```{r warning=FALSE}


#lgdppp
###################
c3_g <- list()
c3_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c3 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "st_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~lgdppp,#assen
              data = rrst, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c3,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c3,
            type = "dynamic",
            na.rm = T)

#save event study
c3_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c3_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C3G_reg[["lgdppp"]] <- c3_g
C3E_reg[["lgdppp"]] <- c3_e

```


#lpop
```{r warning=FALSE}


#lpop
###################
c3_g <- list()
c3_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c3 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "st_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~lpop,#assen
              data = rrst, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c3,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c3,
            type = "dynamic",
            na.rm = T)

#save event study
c3_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c3_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C3G_reg[["lpop"]] <- c3_g
C3E_reg[["lpop"]] <- c3_e

```

#lpop_den
```{r warning=FALSE}


#lpopden
###################
c3_g <- list()
c3_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c3 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "st_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~lpop_den,#assen
              data = rrst, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c3,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c3,
            type = "dynamic",
            na.rm = T)

#save event study
c3_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c3_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C3G_reg[["lpop_den"]] <- c3_g
C3E_reg[["lpop_den"]] <- c3_e

```


#rent_sub
```{r warning=FALSE}


#rent_sub
###################
c3_g <- list()
c3_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c3 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "st_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~rent_sub,#assen
              data = rrst, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c3,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c3,
            type = "dynamic",
            na.rm = T)

#save event study
c3_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c3_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C3G_reg[["rent_sub"]] <- c3_g
C3E_reg[["rent_sub"]] <- c3_e

```

#schuldnerquote
```{r warning=FALSE}


#schuldnerquote
###################
c3_g <- list()
c3_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c3 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "st_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~Schuldnerquote,#assen
              data = rrst, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c3,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c3,
            type = "dynamic",
            na.rm = T)

#save event study
c3_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c3_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C3G_reg[["schuldnerquote"]] <- c3_g
C3E_reg[["schuldnerquote"]] <- c3_e

```

#sgb
```{r warning=FALSE}


#sgb
###################
c3_g <- list()
c3_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c3 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "st_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~sgb,#assen
              data = rrst, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c3,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c3,
            type = "dynamic",
            na.rm = T)

#save event study
c3_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c3_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C3G_reg[["sgb"]] <- c3_g
C3E_reg[["sgb"]] <- c3_e

```


#null
```{r warning=FALSE}


#NULL
###################
c3_g <- list()
c3_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c3 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "st_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =NULL,#assen
              data = rrst, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c3,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c3,
            type = "dynamic",
            na.rm = T)

#save event study
c3_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c3_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C3G_reg[["keine"]] <- c3_g
C3E_reg[["keine"]] <- c3_e

list.save(C3E_reg, here("output/c3/C3E_reg.rds"))
list.save(C3G_reg, here("output/c3/C3G_reg.rds"))
```


```{r}




log_ratios <- c(
#overall investment
"log_inv_hp_city" ,
"log_inv_mp_city", 
"log_inv_lp_city",
"log_inv_tc",
  
"log_Abbruchreif",
"log_Abbruchreif",
"log_Abbruchreif_lp_nh_city",
"log_Abbruchreif_mp_nh_city",
"log_Abbruchreif_hp_nh_city",

#"R_obzu_Erstbezug",
"log_Erstbezug",
"log_Erstbezug_lp_nh_city" ,
"log_Erstbezug_mp_nh_city",
"log_Erstbezug_hp_nh_city",

#Erstbezug_nach_Sanierung
"log_Erstbezug_nach_Sanierung",
"log_Erstbezug_nach_Sanierung_lp_nh_city",
"log_Erstbezug_nach_Sanierung_mp_nh_city",
"log_Erstbezug_nach_Sanierung_hp_nh_city",

#"R_obzu_Gepflegt",
"log_Gepflegt",
"log_Gepflegt_lp_nh_city",
"log_Gepflegt_mp_nh_city" ,
"log_Gepflegt_hp_nh_city" ,

#Modernisiert
"log_Modernisiert",
"log_Modernisiert_lp_nh_city",
"log_Modernisiert_mp_nh_city" ,
"log_Modernisiert_hp_nh_city",

#"R_obzu_Nach_Vereinbarung",
"log_Nach_Vereinbarung",
"log_Nach_Vereinbarung_lp_nh_city",
"log_Nach_Vereinbarung_mp_nh_city",
"log_Nach_Vereinbarung_hp_nh_city",

#"R_obzu_Neuwertig",
"log_Neuwertig",
"log_Neuwertig_lp_nh_city",
"log_Neuwertig_mp_nh_city",
"log_Neuwertig_hp_nh_city",

#renovierungsbeduerftig
"log_Renovierungsbeduerftig",
"log_Renovierungsbeduerftig_lp_nh_city",
"log_Renovierungsbeduerftig_mp_nh_city",
"log_Renovierungsbeduerftig_hp_nh_city",

#saniert
"log_saniert",
"log_saniert_lp_nh_city",
"log_saniert_mp_nh_city",
"log_saniert_hp_nh_city",

#"R_obzu_Vollstaendig_Renoviert",
"log_Vollstaendig_Renoviert",
"log_Vollstaendig_Renoviert_lp_nh_city",
"log_Vollstaendig_Renoviert_mp_nh_city",
"log_Vollstaendig_Renoviert_hp_nh_city",

#"R_obzu_Unbekannter_Zustand",
"log_Unbekannter_Zustand",
"log_Unbekannter_Zustand_lp_nh_city",
"log_Unbekannter_Zustand_mp_nh_city",
"log_Unbekannter_Zustand_hp_nh_city"
)

cvars <- c("lgdppp",
           "lpop_den",
           "lpop",
           "rent_sub",
           "schuldnerquote",
           "sgb",
           "keine"
           )

#create result data set

# group effects

#nrft

MODELS <- list()
for (q in cvars) {
  for (j in log_ratios) {
    m_dt <- list()
    #extract values and save in matrix
    att <- C1E_reg[[q]][[j]]$overall.att
    se <- C1E_reg[[q]][[j]]$overall.se
    type <- C1E_reg[[q]][[j]]$type
    gname <- C1E_reg[[q]][[j]][["DIDparams"]][["gname"]]#comparison
    N <- C1E_reg[[q]][[j]][["DIDparams"]][["n"]]# N
    est_m <- C1E_reg[[q]][[j]][["DIDparams"]][["call"]][["est_method"]]#estimator
    y_name <- C1E_reg[[q]][[j]][["DIDparams"]][["DIDparams"]][["yname"]]
    cont_v <- C1E_reg[[q]][[j]][["DIDparams"]][["DIDparams"]][["xformla"]][[2]]
    m_dt[["c_var"]] <- cont_v
    m_dt[["dep_var"]] <- y_name
    m_dt[["ATT"]] <- att
    m_dt[["SE"]] <- se
    m_dt[["CV"]] <- qt(0.975,df= N-1)
    m_dt[["type"]] <- type
    m_dt[["gname"]] <- gname
    m_dt[["N"]] <- N
    m_dt[["est_m"]] <- est_m
    
    MODELS[[paste0(j,"_",q)]] <- m_dt
  }
}

df_MODEL <- as.data.frame(do.call(rbind, MODELS))
df_MODEL <- tibble::rownames_to_column(df_MODEL, "row_names")


df_MODEL$CV <- as.numeric(df_MODEL$CV)
df_MODEL$SE <- as.numeric(df_MODEL$SE)
df_MODEL$ATT <- as.numeric(df_MODEL$ATT)

#clean columnes
df_MODEL$N <- as.numeric(df_MODEL$N)
df_MODEL$low_conf <- df_MODEL$ATT - (df_MODEL$CV * df_MODEL$SE)
df_MODEL$up_conf<- df_MODEL$ATT + (df_MODEL$CV * df_MODEL$SE)

df_nrft <- df_MODEL
#calculate confidence intervalls



#ftrr

MODELS <- list()
for (q in cvars) {
  for (j in log_ratios) {
    m_dt <- list()
    #extract values and save in matrix
    att <- C2E_reg[[q]][[j]]$overall.att
    se <- C2E_reg[[q]][[j]]$overall.se
    type <- C2E_reg[[q]][[j]]$type
    gname <- C2E_reg[[q]][[j]][["DIDparams"]][["gname"]]#comparison
    N <- C2E_reg[[q]][[j]][["DIDparams"]][["n"]]# N
    est_m <- C2E_reg[[q]][[j]][["DIDparams"]][["call"]][["est_method"]]#estimator
    y_name <- C2E_reg[[q]][[j]][["DIDparams"]][["DIDparams"]][["yname"]]
    cont_v <- C2E_reg[[q]][[j]][["DIDparams"]][["DIDparams"]][["xformla"]][[2]]
    m_dt[["c_var"]] <- cont_v
    m_dt[["dep_var"]] <- y_name
    m_dt[["ATT"]] <- att
    m_dt[["SE"]] <- se
    m_dt[["CV"]] <- qt(0.975,df= N-1)
    m_dt[["type"]] <- type
    m_dt[["gname"]] <- gname
    m_dt[["N"]] <- N
    m_dt[["est_m"]] <- est_m
    
    MODELS[[paste0(j,"_",q)]] <- m_dt
  }
}

df_MODEL <- as.data.frame(do.call(rbind, MODELS))
df_MODEL <- tibble::rownames_to_column(df_MODEL, "row_names")


df_MODEL$CV <- as.numeric(df_MODEL$CV)
df_MODEL$SE <- as.numeric(df_MODEL$SE)
df_MODEL$ATT <- as.numeric(df_MODEL$ATT)

#clean columnes
df_MODEL$N <- as.numeric(df_MODEL$N)
df_MODEL$low_conf <- df_MODEL$ATT - (df_MODEL$CV * df_MODEL$SE)
df_MODEL$up_conf<- df_MODEL$ATT + (df_MODEL$CV * df_MODEL$SE)

df_ftrr <- df_MODEL


#rrst
MODELS <- list()
for (q in cvars) {
  for (j in log_ratios) {
    m_dt <- list()
    #extract values and save in matrix
    att <- C3E_reg[[q]][[j]]$overall.att
    se <- C3E_reg[[q]][[j]]$overall.se
    type <- C3E_reg[[q]][[j]]$type
    gname <- C3E_reg[[q]][[j]][["DIDparams"]][["gname"]]#comparison
    N <- C3E_reg[[q]][[j]][["DIDparams"]][["n"]]# N
    est_m <- C3E_reg[[q]][[j]][["DIDparams"]][["call"]][["est_method"]]#estimator
    y_name <- C3E_reg[[q]][[j]][["DIDparams"]][["DIDparams"]][["yname"]]
    cont_v <- C3E_reg[[q]][[j]][["DIDparams"]][["DIDparams"]][["xformla"]][[2]]
    m_dt[["c_var"]] <- cont_v
    m_dt[["dep_var"]] <- y_name
    m_dt[["ATT"]] <- att
    m_dt[["SE"]] <- se
    m_dt[["CV"]] <- qt(0.975,df= N-1)
    m_dt[["type"]] <- type
    m_dt[["gname"]] <- gname
    m_dt[["N"]] <- N
    m_dt[["est_m"]] <- est_m
    
    MODELS[[paste0(j,"_",q)]] <- m_dt
  }
}

df_MODEL <- as.data.frame(do.call(rbind, MODELS))
df_MODEL <- tibble::rownames_to_column(df_MODEL, "row_names")


df_MODEL$CV <- as.numeric(df_MODEL$CV)
df_MODEL$SE <- as.numeric(df_MODEL$SE)
df_MODEL$ATT <- as.numeric(df_MODEL$ATT)

#clean columnes
df_MODEL$N <- as.numeric(df_MODEL$N)
df_MODEL$low_conf <- df_MODEL$ATT - (df_MODEL$CV * df_MODEL$SE)
df_MODEL$up_conf<- df_MODEL$ATT + (df_MODEL$CV * df_MODEL$SE)

df_rrst <- df_MODEL



```


```{r}

#bind all singel modells for the different comparisons
df_RC_E <- rbind(df_nrft, df_ftrr)
df_RC_E <- rbind(df_RC_E, df_rrst)
```


# data set for event study overall att 
```{r}
# group effects

#nrft

MODELS <- list()
for (q in cvars) {
  for (j in log_ratios) {
    m_dt <- list()
    #extract values and save in matrix
    att <- C1G_reg[[q]][[j]]$overall.att
    se <- C1G_reg[[q]][[j]]$overall.se
    type <- C1G_reg[[q]][[j]]$type
    gname <- C1G_reg[[q]][[j]][["DIDparams"]][["gname"]]#comparison
    N <- C1G_reg[[q]][[j]][["DIDparams"]][["n"]]# N
    est_m <- C1G_reg[[q]][[j]][["DIDparams"]][["call"]][["est_method"]]#estimator
    y_name <- C1G_reg[[q]][[j]][["DIDparams"]][["DIDparams"]][["yname"]]
    cont_v <- C1G_reg[[q]][[j]][["DIDparams"]][["DIDparams"]][["xformla"]][[2]]
    m_dt[["c_var"]] <- cont_v
    m_dt[["dep_var"]] <- y_name
    m_dt[["ATT"]] <- att
    m_dt[["SE"]] <- se
    m_dt[["CV"]] <- qt(0.975,df= N-1)
    m_dt[["type"]] <- type
    m_dt[["gname"]] <- gname
    m_dt[["N"]] <- N
    m_dt[["est_m"]] <- est_m
    
    MODELS[[paste0(j,"_",q)]] <- m_dt
  }
}

df_MODEL <- as.data.frame(do.call(rbind, MODELS))
df_MODEL <- tibble::rownames_to_column(df_MODEL, "row_names")


df_MODEL$CV <- as.numeric(df_MODEL$CV)
df_MODEL$SE <- as.numeric(df_MODEL$SE)
df_MODEL$ATT <- as.numeric(df_MODEL$ATT)

#clean columnes
df_MODEL$N <- as.numeric(df_MODEL$N)
df_MODEL$low_conf <- df_MODEL$ATT - (df_MODEL$CV * df_MODEL$SE)
df_MODEL$up_conf<- df_MODEL$ATT + (df_MODEL$CV * df_MODEL$SE)

df_nrft <- df_MODEL
#calculate confidence intervalls



#ftrr

MODELS <- list()
for (q in cvars) {
  for (j in log_ratios) {
    m_dt <- list()
    #extract values and save in matrix
    att <- C2G_reg[[q]][[j]]$overall.att
    se <- C2G_reg[[q]][[j]]$overall.se
    type <- C2G_reg[[q]][[j]]$type
    gname <- C2G_reg[[q]][[j]][["DIDparams"]][["gname"]]#comparison
    N <- C2G_reg[[q]][[j]][["DIDparams"]][["n"]]# N
    est_m <- C2G_reg[[q]][[j]][["DIDparams"]][["call"]][["est_method"]]#estimator
    y_name <- C2G_reg[[q]][[j]][["DIDparams"]][["DIDparams"]][["yname"]]
    cont_v <- C2G_reg[[q]][[j]][["DIDparams"]][["DIDparams"]][["xformla"]][[2]]
    m_dt[["c_var"]] <- cont_v
    m_dt[["dep_var"]] <- y_name
    m_dt[["ATT"]] <- att
    m_dt[["SE"]] <- se
    m_dt[["CV"]] <- qt(0.975,df= N-1)
    m_dt[["type"]] <- type
    m_dt[["gname"]] <- gname
    m_dt[["N"]] <- N
    m_dt[["est_m"]] <- est_m
    
    MODELS[[paste0(j,"_",q)]] <- m_dt
  }
}

df_MODEL <- as.data.frame(do.call(rbind, MODELS))
df_MODEL <- tibble::rownames_to_column(df_MODEL, "row_names")


df_MODEL$CV <- as.numeric(df_MODEL$CV)
df_MODEL$SE <- as.numeric(df_MODEL$SE)
df_MODEL$ATT <- as.numeric(df_MODEL$ATT)

#clean columnes
df_MODEL$N <- as.numeric(df_MODEL$N)
df_MODEL$low_conf <- df_MODEL$ATT - (df_MODEL$CV * df_MODEL$SE)
df_MODEL$up_conf<- df_MODEL$ATT + (df_MODEL$CV * df_MODEL$SE)

df_ftrr <- df_MODEL


#rrst
MODELS <- list()
for (q in cvars) {
  for (j in log_ratios) {
    m_dt <- list()
    #extract values and save in matrix
    att <- C3G_reg[[q]][[j]]$overall.att
    se <- C3G_reg[[q]][[j]]$overall.se
    type <- C3G_reg[[q]][[j]]$type
    gname <- C3G_reg[[q]][[j]][["DIDparams"]][["gname"]]#comparison
    N <- C3G_reg[[q]][[j]][["DIDparams"]][["n"]]# N
    est_m <- C3G_reg[[q]][[j]][["DIDparams"]][["call"]][["est_method"]]#estimator
    y_name <- C3G_reg[[q]][[j]][["DIDparams"]][["DIDparams"]][["yname"]]
    cont_v <- C3G_reg[[q]][[j]][["DIDparams"]][["DIDparams"]][["xformla"]][[2]]
    m_dt[["c_var"]] <- cont_v
    m_dt[["dep_var"]] <- y_name
    m_dt[["ATT"]] <- att
    m_dt[["SE"]] <- se
    m_dt[["CV"]] <- qt(0.975,df= N-1)
    m_dt[["type"]] <- type
    m_dt[["gname"]] <- gname
    m_dt[["N"]] <- N
    m_dt[["est_m"]] <- est_m
    
    MODELS[[paste0(j,"_",q)]] <- m_dt
  }
}

df_MODEL <- as.data.frame(do.call(rbind, MODELS))
df_MODEL <- tibble::rownames_to_column(df_MODEL, "row_names")


df_MODEL$CV <- as.numeric(df_MODEL$CV)
df_MODEL$SE <- as.numeric(df_MODEL$SE)
df_MODEL$ATT <- as.numeric(df_MODEL$ATT)

#clean columnes
df_MODEL$N <- as.numeric(df_MODEL$N)
df_MODEL$low_conf <- df_MODEL$ATT - (df_MODEL$CV * df_MODEL$SE)
df_MODEL$up_conf<- df_MODEL$ATT + (df_MODEL$CV * df_MODEL$SE)

df_rrst <- df_MODEL





```
 
```{r}

#bind all singel modells for the different comparisons
df_RC_G <- rbind(df_nrft, df_ftrr)
df_RC_G <- rbind(df_RC_G, df_rrst)
```


```{r}



#save all models
#fwrite(df_nrft, "df_nrft.csv")
#fwrite(df_ftrr, "df_ftrr.csv")
#fwrite(df_rrst, "df_rrst.csv")

```


```{r}

#get columne for signifikance

#bind all singel modells for the different comparisons
df_RC_reg <- rbind(df_RC_G, df_RC_E)

#get new columne for att positive or negativ
df_RC_reg <- df_RC_reg%>% 
  mutate(
   p_n = case_when(
      ATT > 0 ~ "+",
      ATT < 0 ~ "-"
    ))


df_RC_reg <- df_RC_reg%>%mutate(
  sig_5 = case_when(
   p_n == "-" & 0 > up_conf ~ "*",
   p_n == "+" & 0 < low_conf ~ "*"
  )
)



#only significnat models
sig5_model_reg <- df_RC_reg%>%filter(is.na(sig_5)==F)

#get columne for control vars
df_RC_reg$c_var <- gsub(".*_", "", df_RC_reg$row_names)

df_RC_reg$type <- as.character(df_RC_reg$type)
df_RC_reg$gname <- as.character(df_RC_reg$gname)
df_RC_reg$est_m <- as.character(df_RC_reg$est_m)

df_RC_reg<-unique(df_RC_reg)

#####get more significanc levels

#significant on 1% level**
#get critical value for 1% level
df_RC_reg$cv_99 <- qt(0.995,df= df_RC_reg$N-1)
#get confidence interval
df_RC_reg$low_conf_99 <- df_RC_reg$ATT - (df_RC_reg$cv_99 * df_RC_reg$SE)
df_RC_reg$up_conf_99<- df_RC_reg$ATT + (df_RC_reg$cv_99 * df_RC_reg$SE)
#mark the significant models with two stars**
df_RC_reg <- df_RC_reg%>%mutate(
  sig_1 = case_when(
   p_n == "-" & 0 > up_conf_99 ~ "**",
   p_n == "+" & 0 < low_conf_99 ~ "**"
  )
)


#significant on 0,1% level***
#get critical value for 0,1% level
df_RC_reg$cv_0.1 <- qt(0.9995,df= df_RC_reg$N-1)
#get confidenc interval
df_RC_reg$low_conf_0.1 <- df_RC_reg$ATT - (df_RC_reg$cv_0.1 * df_RC_reg$SE)
df_RC_reg$up_conf_0.1<- df_RC_reg$ATT + (df_RC_reg$cv_0.1 * df_RC_reg$SE)
#mark the significant models with three stars***
df_RC_reg <- df_RC_reg%>%mutate(
  sig_0.1 = case_when(
   p_n == "-" & 0 > up_conf_0.1 ~ "***",
   p_n == "+" & 0 < low_conf_0.1 ~ "***"
  )
)


#save data set with all calculated models
#write_xlsx(df_RC_reg, "~/rent_control/output/DF_reg_models.xlsx")
#fwrite(df_RC_reg, "df_RC_reg.csv")
```





# ipw

######################
models for every controll var
```{r}


log_ratios <- c(
#overall investment
"log_inv_hp_city" ,
"log_inv_mp_city", 
"log_inv_lp_city",
"log_inv_tc",
  
#"R_obzu_Abbruchreif",
"log_Abbruchreif",
"log_Abbruchreif_lp_nh_city",
"log_Abbruchreif_mp_nh_city",
"log_Abbruchreif_hp_nh_city",

#"R_obzu_Erstbezug",
"log_Erstbezug",
"log_Erstbezug_lp_nh_city" ,
"log_Erstbezug_mp_nh_city",
"log_Erstbezug_hp_nh_city",

#Erstbezug_nach_Sanierung
"log_Erstbezug_nach_Sanierung",
"log_Erstbezug_nach_Sanierung_lp_nh_city",
"log_Erstbezug_nach_Sanierung_mp_nh_city",
"log_Erstbezug_nach_Sanierung_hp_nh_city",

#"R_obzu_Gepflegt",
"log_Gepflegt",
"log_Gepflegt_lp_nh_city",
"log_Gepflegt_mp_nh_city" ,
"log_Gepflegt_hp_nh_city" ,

#Modernisiert
"log_Modernisiert",
"log_Modernisiert_lp_nh_city",
"log_Modernisiert_mp_nh_city" ,
"log_Modernisiert_hp_nh_city",

#"R_obzu_Nach_Vereinbarung",
"log_Nach_Vereinbarung",
"log_Nach_Vereinbarung_lp_nh_city",
"log_Nach_Vereinbarung_mp_nh_city",
"log_Nach_Vereinbarung_hp_nh_city",

#"R_obzu_Neuwertig",
"log_Neuwertig",
"log_Neuwertig_lp_nh_city",
"log_Neuwertig_mp_nh_city",
"log_Neuwertig_hp_nh_city",

#renovierungsbeduerftig
"log_Renovierungsbeduerftig",
"log_Renovierungsbeduerftig_lp_nh_city",
"log_Renovierungsbeduerftig_mp_nh_city",
"log_Renovierungsbeduerftig_hp_nh_city",

#saniert
"log_saniert",
"log_saniert_lp_nh_city",
"log_saniert_mp_nh_city",
"log_saniert_hp_nh_city",

#"R_obzu_Vollstaendig_Renoviert",
"log_Vollstaendig_Renoviert",
"log_Vollstaendig_Renoviert_lp_nh_city",
"log_Vollstaendig_Renoviert_mp_nh_city",
"log_Vollstaendig_Renoviert_hp_nh_city",

#"R_obzu_Unbekannter_Zustand",
"log_Unbekannter_Zustand",
"log_Unbekannter_Zustand_lp_nh_city",
"log_Unbekannter_Zustand_mp_nh_city",
"log_Unbekannter_Zustand_hp_nh_city"
)

C1G_ipw <- list()
C1E_ipw <- list()

C2G_ipw <- list()
C2E_ipw <- list()

C3G_ipw <- list()
C3E_ipw <- list()
```


##nrft

#models for each controll variable
```{r warning=FALSE}


#lgdppp
###################
c1_g <- list()
c1_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c1 <- att_gt(yname = log_inv_hp_city, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "ft_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~lgdppp,#assen
              data = nrft, #anpassen
              control_group="notyettreated",
              est_method = "ipw",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c1,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c1,
            type = "dynamic",
            na.rm = T)

#save event study
c1_e[[j]] <- es

#get plot
did_plot_g <- ggdid(gp)

#did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in #quality")) +
 # scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c1_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C1G_ipw[["lgdppp"]] <- c1_g
C1E_ipw[["lgdppp"]] <- c1_e

```


#lpop
```{r warning=FALSE}


#lpop
###################
c1_g <- list()
c1_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c1 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "ft_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~lpop,#assen
              data = nrft, #anpassen
              control_group="notyettreated",
              est_method = "ipw",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c1,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c1,
            type = "dynamic",
            na.rm = T)

#save event study
c1_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c1_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C1G_ipw[["lpop"]] <- c1_g
C1E_ipw[["lpop"]] <- c1_e

```

#lpop_den
```{r warning=FALSE}


#lpopden
###################
c1_g <- list()
c1_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c1 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "ft_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~lpop_den,#assen
              data = nrft, #anpassen
              control_group="notyettreated",
              est_method = "ipw",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c1,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c1,
            type = "dynamic",
            na.rm = T)

#save event study
c1_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c1_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C1G_ipw[["lpop_den"]] <- c1_g
C1E_ipw[["lpop_den"]] <- c1_e

```


#rent_sub
```{r warning=FALSE}


#rent_sub
###################
c1_g <- list()
c1_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c1 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "ft_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~rent_sub,#assen
              data = nrft, #anpassen
              control_group="notyettreated",
              est_method = "ipw",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c1,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c1,
            type = "dynamic",
            na.rm = T)

#save event study
c1_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c1_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C1G_ipw[["rent_sub"]] <- c1_g
C1E_ipw[["rent_sub"]] <- c1_e

```

#schuldnerquote
```{r warning=FALSE}


#schuldnerquote
###################
c1_g <- list()
c1_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c1 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "ft_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~Schuldnerquote,#assen
              data = nrft, #anpassen
              control_group="notyettreated",
              est_method = "ipw",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c1,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c1,
            type = "dynamic",
            na.rm = T)

#save event study
c1_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c1_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C1G_ipw[["schuldnerquote"]] <- c1_g
C1E_ipw[["schuldnerquote"]] <- c1_e

```

#sgb
```{r warning=FALSE}


#sgb
###################
c1_g <- list()
c1_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c1 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "ft_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~sgb,#assen
              data = nrft, #anpassen
              control_group="notyettreated",
              est_method = "ipw",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c1,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c1,
            type = "dynamic",
            na.rm = T)

#save event study
c1_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c1_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C1G_ipw[["sgb"]] <- c1_g
C1E_ipw[["sgb"]] <- c1_e

```


#null
```{r warning=FALSE}


#NULL
###################
c1_g <- list()
c1_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c1 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "ft_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =NULL,#assen
              data = nrft, #anpassen
              control_group="notyettreated",
              est_method = "ipw",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c1,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c1,
            type = "dynamic",
            na.rm = T)

#save event study
c1_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c1_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C1G_ipw[["keine"]] <- c1_g
C1E_ipw[["keine"]] <- c1_e

list.save(C1E_ipw, here("output/c1/C1E_ipw.rds"))
list.save(C1G_ipw, here("output/c1/C1G_ipw.rds"))
```



 
#######ftrr
#models for each controll variable
```{r warning=FALSE}


#lgdppp
###################
c2_g <- list()
c2_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c2 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "nta1_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~lgdppp,#assen
              data = ftrr, #anpassen
              control_group="notyettreated",
              est_method = "ipw",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c2,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c2,
            type = "dynamic",
            na.rm = T)

#save event study
c2_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c2_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C2G_ipw[["lgdppp"]] <- c2_g
C2E_ipw[["lgdppp"]] <- c2_e

```


#lpop
```{r warning=FALSE}


#lpop
###################
c2_g <- list()
c2_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c2 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "nta1_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~lpop,#assen
              data = ftrr, #anpassen
              control_group="notyettreated",
              est_method = "ipw",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c2,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c2,
            type = "dynamic",
            na.rm = T)

#save event study
c2_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c2_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C2G_ipw[["lpop"]] <- c2_g
C2E_ipw[["lpop"]] <- c2_e

```

#lpop_den
```{r warning=FALSE}


#lpopden
###################
c2_g <- list()
c2_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c2 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "nta1_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~lpop_den,#assen
              data = ftrr, #anpassen
              control_group="notyettreated",
              est_method = "ipw",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c2,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c2,
            type = "dynamic",
            na.rm = T)

#save event study
c2_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c2_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C2G_ipw[["lpop_den"]] <- c2_g
C2E_ipw[["lpop_den"]] <- c2_e

```


#rent_sub
```{r warning=FALSE}


#rent_sub
###################
c2_g <- list()
c2_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c2 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "nta1_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~rent_sub,#assen
              data = ftrr, #anpassen
              control_group="notyettreated",
              est_method = "ipw",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c2,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c2,
            type = "dynamic",
            na.rm = T)

#save event study
c2_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c2_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C2G_ipw[["rent_sub"]] <- c2_g
C2E_ipw[["rent_sub"]] <- c2_e

```

#schuldnerquote
```{r warning=FALSE}


#schuldnerquote
###################
c2_g <- list()
c2_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c2 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "nta1_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~Schuldnerquote,#assen
              data = ftrr, #anpassen
              control_group="notyettreated",
              est_method = "ipw",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c2,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c2,
            type = "dynamic",
            na.rm = T)

#save event study
c2_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c2_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C2G_ipw[["schuldnerquote"]] <- c2_g
C2E_ipw[["schuldnerquote"]] <- c2_e

```

#sgb
```{r warning=FALSE}


#sgb
###################
c2_g <- list()
c2_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c2 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "nta1_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~sgb,#assen
              data = ftrr, #anpassen
              control_group="notyettreated",
              est_method = "ipw",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c2,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c2,
            type = "dynamic",
            na.rm = T)

#save event study
c2_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c2_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C2G_ipw[["sgb"]] <- c2_g
C2E_ipw[["sgb"]] <- c2_e

```


#null
```{r warning=FALSE}


#NULL
###################
c2_g <- list()
c2_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c2 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "nta1_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =NULL,#assen
              data = ftrr, #anpassen
              control_group="notyettreated",
              est_method = "ipw",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c2,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c2,
            type = "dynamic",
            na.rm = T)

#save event study
c2_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c2_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}

C2E_ipw[["keine"]] <- c2_e
C2G_ipw[["keine"]] <- c2_g

list.save(C2E_ipw, here("output/c2/C2E_ipw.rds"))
list.save(C2G_ipw, here("output/c2/C2G_ipw.rds"))
```






```{r}
C3G_ipw <- list()
C3E_ipw <- list()
```



#rrst

#######ftrr
#models for each controll variable
```{r warning=FALSE}


#lgdppp
###################
c3_g <- list()
c3_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c3 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "st_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~lgdppp,#assen
              data = rrst, #anpassen
              control_group="notyettreated",
              est_method = "ipw",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c3,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c3,
            type = "dynamic",
            na.rm = T)

#save event study
c3_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c3_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C3G_ipw[["lgdppp"]] <- c3_g
C3E_ipw[["lgdppp"]] <- c3_e

```


#lpop
```{r warning=FALSE}


#lpop
###################
c3_g <- list()
c3_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c3 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "st_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~lpop,#assen
              data = rrst, #anpassen
              control_group="notyettreated",
              est_method = "ipw",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c3,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c3,
            type = "dynamic",
            na.rm = T)

#save event study
c3_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c3_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C3G_ipw[["lpop"]] <- c3_g
C3E_ipw[["lpop"]] <- c3_e

```

#lpop_den
```{r warning=FALSE}


#lpopden
###################
c3_g <- list()
c3_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c3 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "st_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~lpop_den,#assen
              data = rrst, #anpassen
              control_group="notyettreated",
              est_method = "ipw",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c3,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c3,
            type = "dynamic",
            na.rm = T)

#save event study
c3_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c3_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C3G_ipw[["lpop_den"]] <- c3_g
C3E_ipw[["lpop_den"]] <- c3_e

```


#rent_sub
```{r warning=FALSE}


#rent_sub
###################
c3_g <- list()
c3_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c3 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "st_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~rent_sub,#assen
              data = rrst, #anpassen
              control_group="notyettreated",
              est_method = "ipw",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c3,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c3,
            type = "dynamic",
            na.rm = T)

#save event study
c3_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c3_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C3G_ipw[["rent_sub"]] <- c3_g
C3E_ipw[["rent_sub"]] <- c3_e

```

#schuldnerquote
```{r warning=FALSE}


#schuldnerquote
###################
c3_g <- list()
c3_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c3 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "st_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~Schuldnerquote,#assen
              data = rrst, #anpassen
              control_group="notyettreated",
              est_method = "ipw",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c3,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c3,
            type = "dynamic",
            na.rm = T)

#save event study
c3_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c3_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C3G_ipw[["schuldnerquote"]] <- c3_g
C3E_ipw[["schuldnerquote"]] <- c3_e

```

#sgb
```{r warning=FALSE}


#sgb
###################
c3_g <- list()
c3_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c3 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "st_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~sgb,#assen
              data = rrst, #anpassen
              control_group="notyettreated",
              est_method = "ipw",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c3,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c3,
            type = "dynamic",
            na.rm = T)

#save event study
c3_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c3_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C3G_ipw[["sgb"]] <- c3_g
C3E_ipw[["sgb"]] <- c3_e

```


#null
```{r warning=FALSE}


#NULL
###################
c3_g <- list()
c3_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c3 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "st_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =NULL,#assen
              data = rrst, #anpassen
              control_group="notyettreated",
              est_method = "ipw",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c3,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c3,
            type = "dynamic",
            na.rm = T)

#save event study
c3_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c3_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C3G_ipw[["keine"]] <- c3_g
C3E_ipw[["keine"]] <- c3_e

list.save(C3E_ipw, here("output/c3/C3E_ipw.rds"))
list.save(C3G_ipw, here("output/c3/C3G_ipw.rds"))
```

```{r}
#ipw
cvars <- c("lgdppp",
           "lpop_den",
           "lpop",
           "rent_sub",
           "Schuldnerquote",
           "sgb",
           "keine"
           )

#create result data set

# group effects

#nrft
#rrst
MODELS <- list()
for (q in cvars) {
  for (j in log_ratios) {
    m_dt <- list()
    #extract values and save in matrix
    att <- C1G_ipw[[q]][[j]]$overall.att
    se <- C1G_ipw[[q]][[j]]$overall.se
    cv <- C1G_ipw[[q]][[j]][["crit.val.egt"]]
    type <- C1G_ipw[[q]][[j]]$type
    gname <- C1G_ipw[[q]][[j]][["DIDparams"]][["gname"]]#comparison
    N <- C1G_ipw[[q]][[j]][["DIDparams"]][["n"]]# N
    est_m <- C1G_ipw[[q]][[j]][["DIDparams"]][["call"]][["est_method"]]#estimator
    y_name <- C1G_ipw[[q]][[j]][["DIDparams"]][["DIDparams"]][["yname"]]
    cont_v <- C1G_ipw[[q]][[j]][["DIDparams"]][["DIDparams"]][["xformla"]][[2]]
    m_dt[["c_var"]] <- cont_v
    m_dt[["dep_var"]] <- y_name
    m_dt[["ATT"]] <- att
    m_dt[["SE"]] <- se
    m_dt[["CV"]] <- qt(0.975,df= N-1)
    m_dt[["type"]] <- type
    m_dt[["gname"]] <- gname
    m_dt[["N"]] <- N
    m_dt[["est_m"]] <- est_m
    
    MODELS[[paste0(j,"_",q)]] <- m_dt
  }
}

df_MODEL <- as.data.frame(do.call(rbind, MODELS))
df_MODEL <- tibble::rownames_to_column(df_MODEL, "row_names")


df_MODEL$CV <- as.numeric(df_MODEL$CV)
df_MODEL$SE <- as.numeric(df_MODEL$SE)
df_MODEL$ATT <- as.numeric(df_MODEL$ATT)

#clean columnes
df_MODEL$N <- as.numeric(df_MODEL$N)
df_MODEL$low_conf <- df_MODEL$ATT - (df_MODEL$CV * df_MODEL$SE)
df_MODEL$up_conf<- df_MODEL$ATT + (df_MODEL$CV * df_MODEL$SE)

df_nrft_G <- df_MODEL

MODELS <- list()
for (q in cvars) {
  for (j in log_ratios) {
    m_dt <- list()
    #extract values and save in matrix
    att <- C1E_ipw[[q]][[j]]$overall.att
    se <- C1E_ipw[[q]][[j]]$overall.se
    cv <- C1E_ipw[[q]][[j]][["crit.val.egt"]][["95%"]]
    type <- C1E_ipw[[q]][[j]]$type
    gname <- C1E_ipw[[q]][[j]][["DIDparams"]][["gname"]]#comparison
    N <- C1E_ipw[[q]][[j]][["DIDparams"]][["n"]]# N
    est_m <- C1E_ipw[[q]][[j]][["DIDparams"]][["call"]][["est_method"]]#estimator
    y_name <- C1E_ipw[[q]][[j]][["DIDparams"]][["DIDparams"]][["yname"]]
    cont_v <- C1E_ipw[[q]][[j]][["DIDparams"]][["DIDparams"]][["xformla"]][[2]]
    m_dt[["c_var"]] <- cont_v
    m_dt[["dep_var"]] <- y_name
    m_dt[["ATT"]] <- att
    m_dt[["SE"]] <- se
    m_dt[["CV"]] <- qt(0.975,df= N-1)
    m_dt[["type"]] <- type
    m_dt[["gname"]] <- gname
    m_dt[["N"]] <- N
    m_dt[["est_m"]] <- est_m
    
    MODELS[[paste0(j,"_",q)]] <- m_dt
  }
}

df_MODEL <- as.data.frame(do.call(rbind, MODELS))
df_MODEL <- tibble::rownames_to_column(df_MODEL, "row_names")


df_MODEL$CV <- as.numeric(df_MODEL$CV)
df_MODEL$SE <- as.numeric(df_MODEL$SE)
df_MODEL$ATT <- as.numeric(df_MODEL$ATT)

#clean columnes
df_MODEL$N <- as.numeric(df_MODEL$N)
df_MODEL$low_conf <- df_MODEL$ATT - (df_MODEL$CV * df_MODEL$SE)
df_MODEL$up_conf<- df_MODEL$ATT + (df_MODEL$CV * df_MODEL$SE)

df_nrft_E <- df_MODEL
#calculate confidence intervalls



#ftrr
#rrst
MODELS <- list()
for (q in cvars) {
  for (j in log_ratios) {
    m_dt <- list()
    #extract values and save in matrix
    att <- C2G_ipw[[q]][[j]]$overall.att
    se <- C2G_ipw[[q]][[j]]$overall.se
    cv <- C2G_ipw[[q]][[j]][["crit.val.egt"]]
    type <- C2G_ipw[[q]][[j]]$type
    gname <- C2G_ipw[[q]][[j]][["DIDparams"]][["gname"]]#comparison
    N <- C2G_ipw[[q]][[j]][["DIDparams"]][["n"]]# N
    est_m <- C2G_ipw[[q]][[j]][["DIDparams"]][["call"]][["est_method"]]#estimator
    y_name <- C2G_ipw[[q]][[j]][["DIDparams"]][["DIDparams"]][["yname"]]
    cont_v <- C2G_ipw[[q]][[j]][["DIDparams"]][["DIDparams"]][["xformla"]][[2]]
    m_dt[["c_var"]] <- cont_v
    m_dt[["dep_var"]] <- y_name
    m_dt[["ATT"]] <- att
    m_dt[["SE"]] <- se
    m_dt[["CV"]] <- qt(0.975,df= N-1)
    m_dt[["type"]] <- type
    m_dt[["gname"]] <- gname
    m_dt[["N"]] <- N
    m_dt[["est_m"]] <- est_m
    
    MODELS[[paste0(j,"_",q)]] <- m_dt
  }
}

df_MODEL <- as.data.frame(do.call(rbind, MODELS))
df_MODEL <- tibble::rownames_to_column(df_MODEL, "row_names")


df_MODEL$CV <- as.numeric(df_MODEL$CV)
df_MODEL$SE <- as.numeric(df_MODEL$SE)
df_MODEL$ATT <- as.numeric(df_MODEL$ATT)

#clean columnes
df_MODEL$N <- as.numeric(df_MODEL$N)
df_MODEL$low_conf <- df_MODEL$ATT - (df_MODEL$CV * df_MODEL$SE)
df_MODEL$up_conf<- df_MODEL$ATT + (df_MODEL$CV * df_MODEL$SE)

df_ftrr_G <- df_MODEL

MODELS <- list()
for (q in cvars) {
  for (j in log_ratios) {
    m_dt <- list()
    #extract values and save in matrix
    att <- C2E_ipw[[q]][[j]]$overall.att
    se <- C2E_ipw[[q]][[j]]$overall.se
    cv <- C2E_ipw[[q]][[j]][["crit.val.egt"]][["95%"]]
    type <- C2E_ipw[[q]][[j]]$type
    gname <- C2E_ipw[[q]][[j]][["DIDparams"]][["gname"]]#comparison
    N <- C2E_ipw[[q]][[j]][["DIDparams"]][["n"]]# N
    est_m <- C2E_ipw[[q]][[j]][["DIDparams"]][["call"]][["est_method"]]#estimator
    y_name <- C2E_ipw[[q]][[j]][["DIDparams"]][["DIDparams"]][["yname"]]
    cont_v <- C2E_ipw[[q]][[j]][["DIDparams"]][["DIDparams"]][["xformla"]][[2]]
    m_dt[["c_var"]] <- cont_v
    m_dt[["dep_var"]] <- y_name
    m_dt[["ATT"]] <- att
    m_dt[["SE"]] <- se
    m_dt[["CV"]] <- qt(0.975,df= N-1)
    m_dt[["type"]] <- type
    m_dt[["gname"]] <- gname
    m_dt[["N"]] <- N
    m_dt[["est_m"]] <- est_m
    
    MODELS[[paste0(j,"_",q)]] <- m_dt
  }
}

df_MODEL <- as.data.frame(do.call(rbind, MODELS))
df_MODEL <- tibble::rownames_to_column(df_MODEL, "row_names")


df_MODEL$CV <- as.numeric(df_MODEL$CV)
df_MODEL$SE <- as.numeric(df_MODEL$SE)
df_MODEL$ATT <- as.numeric(df_MODEL$ATT)

#clean columnes
df_MODEL$N <- as.numeric(df_MODEL$N)
df_MODEL$low_conf <- df_MODEL$ATT - (df_MODEL$CV * df_MODEL$SE)
df_MODEL$up_conf<- df_MODEL$ATT + (df_MODEL$CV * df_MODEL$SE)

df_ftrr_E <- df_MODEL



#rrst
MODELS <- list()
for (q in cvars) {
  for (j in log_ratios) {
    m_dt <- list()
    #extract values and save in matrix
    att <- C3G_ipw[[q]][[j]]$overall.att
    se <- C3G_ipw[[q]][[j]]$overall.se
    cv <- C3G_ipw[[q]][[j]][["crit.val.egt"]]
    type <- C3G_ipw[[q]][[j]]$type
    gname <- C3G_ipw[[q]][[j]][["DIDparams"]][["gname"]]#comparison
    N <- C3G_ipw[[q]][[j]][["DIDparams"]][["n"]]# N
    est_m <- C3G_ipw[[q]][[j]][["DIDparams"]][["call"]][["est_method"]]#estimator
    y_name <- C3G_ipw[[q]][[j]][["DIDparams"]][["DIDparams"]][["yname"]]
    cont_v <- C3G_ipw[[q]][[j]][["DIDparams"]][["DIDparams"]][["xformla"]][[2]]
    m_dt[["c_var"]] <- cont_v
    m_dt[["dep_var"]] <- y_name
    m_dt[["ATT"]] <- att
    m_dt[["SE"]] <- se
    m_dt[["CV"]] <- qt(0.975,df= N-1)
    m_dt[["type"]] <- type
    m_dt[["gname"]] <- gname
    m_dt[["N"]] <- N
    m_dt[["est_m"]] <- est_m
    
    MODELS[[paste0(j,"_",q)]] <- m_dt
  }
}

df_MODEL <- as.data.frame(do.call(rbind, MODELS))
df_MODEL <- tibble::rownames_to_column(df_MODEL, "row_names")


df_MODEL$CV <- as.numeric(df_MODEL$CV)
df_MODEL$SE <- as.numeric(df_MODEL$SE)
df_MODEL$ATT <- as.numeric(df_MODEL$ATT)

#clean columnes
df_MODEL$N <- as.numeric(df_MODEL$N)
df_MODEL$low_conf <- df_MODEL$ATT - (df_MODEL$CV * df_MODEL$SE)
df_MODEL$up_conf<- df_MODEL$ATT + (df_MODEL$CV * df_MODEL$SE)

df_rrst_G <- df_MODEL


#rrst
MODELS <- list()
for (q in cvars) {
  for (j in log_ratios) {
    m_dt <- list()
    #extract values and save in matrix
    att <- C3E_ipw[[q]][[j]]$overall.att
    se <- C3E_ipw[[q]][[j]]$overall.se
    cv <- C3E_ipw[[q]][[j]][["crit.val.egt"]][["95%"]]
    type <- C3E_ipw[[q]][[j]]$type
    gname <- C3E_ipw[[q]][[j]][["DIDparams"]][["gname"]]#comparison
    N <- C3E_ipw[[q]][[j]][["DIDparams"]][["n"]]# N
    est_m <- C3E_ipw[[q]][[j]][["DIDparams"]][["call"]][["est_method"]]#estimator
    y_name <- C3E_ipw[[q]][[j]][["DIDparams"]][["DIDparams"]][["yname"]]
    cont_v <- C3E_ipw[[q]][[j]][["DIDparams"]][["DIDparams"]][["xformla"]][[2]]
    m_dt[["c_var"]] <- cont_v
    m_dt[["dep_var"]] <- y_name
    m_dt[["ATT"]] <- att
    m_dt[["SE"]] <- se
    m_dt[["CV"]] <- qt(0.975,df= N-1)
    m_dt[["type"]] <- type
    m_dt[["gname"]] <- gname
    m_dt[["N"]] <- N
    m_dt[["est_m"]] <- est_m
    
    MODELS[[paste0(j,"_",q)]] <- m_dt
  }
}



df_MODEL <- as.data.frame(do.call(rbind, MODELS))
df_MODEL <- tibble::rownames_to_column(df_MODEL, "row_names")


df_MODEL$CV <- as.numeric(df_MODEL$CV)
df_MODEL$SE <- as.numeric(df_MODEL$SE)
df_MODEL$ATT <- as.numeric(df_MODEL$ATT)

#clean columnes
df_MODEL$N <- as.numeric(df_MODEL$N)
df_MODEL$low_conf <- df_MODEL$ATT - (df_MODEL$CV * df_MODEL$SE)
df_MODEL$up_conf<- df_MODEL$ATT + (df_MODEL$CV * df_MODEL$SE)

df_rrst_E <- df_MODEL



```

```{r}
df_nrft_ipw <- rbind(df_nrft_E, df_nrft_G)
df_ftrr_ipw <- rbind(df_ftrr_E, df_ftrr_G)
df_rrst_ipw <- rbind(df_rrst_E, df_rrst_G)

df_RC_ipw <- rbind(df_nrft_ipw,df_ftrr_ipw,df_rrst_ipw)


#get new columne for att positive or negativ

df_RC_ipw <- df_RC_ipw%>% 
  mutate(
   p_n = case_when(
      ATT > 0 ~ "+",
      ATT < 0 ~ "-"
    ))


df_RC_ipw <- df_RC_ipw%>%mutate(
  sig_5 = case_when(
   p_n == "-" & 0 > up_conf ~ "*",
   p_n == "+" & 0 < low_conf ~ "*"
  )
)

#fwrite(df_RC_ipw, "df_RC_ipw.csv")
#only significnat models
sig_model_ipw <- df_RC_ipw%>%filter(is.na(sig_5)==F)
```

 



# robustness check: north models

```{r}

#control group: no rent control; treatment group: rent control first time
nrft <- m10_rd %>% filter(TG==1 | TG==0) 
nrft_n <- nrft %>% filter(is.na(north)==F) 

#control group: rent control first time; treatment group: repealed rent control
ftrr <- m10_rd %>% filter(TG==1 | TG==3) 
ftrr_n <- ftrr %>% filter(is.na(north)==F) 
#control group: repealed rent control; treatment group: rent control second time
rrst <- m10_rd %>% filter(TG==3 | TG==2) 
rrst_n <- rrst %>% filter(is.na(north)==F) 
```





```{r}


log_ratios <- c(
#overall investment
"log_inv_hp_city" ,
"log_inv_mp_city", 
"log_inv_lp_city",
"log_inv_tc",
  
#"R_obzu_Abbruchreif",
"log_Abbruchreif",
"log_Abbruchreif_lp_nh_city",
"log_Abbruchreif_mp_nh_city",
"log_Abbruchreif_hp_nh_city",

#"R_obzu_Erstbezug",
"log_Erstbezug",
"log_Erstbezug_lp_nh_city" ,
"log_Erstbezug_mp_nh_city",
"log_Erstbezug_hp_nh_city",

#Erstbezug_nach_Sanierung
"log_Erstbezug_nach_Sanierung",
"log_Erstbezug_nach_Sanierung_lp_nh_city",
"log_Erstbezug_nach_Sanierung_mp_nh_city",
"log_Erstbezug_nach_Sanierung_hp_nh_city",

#"R_obzu_Gepflegt",
"log_Gepflegt",
"log_Gepflegt_lp_nh_city",
"log_Gepflegt_mp_nh_city" ,
"log_Gepflegt_hp_nh_city" ,

#Modernisiert
"log_Modernisiert",
"log_Modernisiert_lp_nh_city",
"log_Modernisiert_mp_nh_city" ,
"log_Modernisiert_hp_nh_city",

#"R_obzu_Nach_Vereinbarung",
"log_Nach_Vereinbarung",
"log_Nach_Vereinbarung_lp_nh_city",
"log_Nach_Vereinbarung_mp_nh_city",
"log_Nach_Vereinbarung_hp_nh_city",

#"R_obzu_Neuwertig",
"log_Neuwertig",
"log_Neuwertig_lp_nh_city",
"log_Neuwertig_mp_nh_city",
"log_Neuwertig_hp_nh_city",

#renovierungsbeduerftig
"log_Renovierungsbeduerftig",
"log_Renovierungsbeduerftig_lp_nh_city",
"log_Renovierungsbeduerftig_mp_nh_city",
"log_Renovierungsbeduerftig_hp_nh_city",

#saniert
"log_saniert",
"log_saniert_lp_nh_city",
"log_saniert_mp_nh_city",
"log_saniert_hp_nh_city",

#"R_obzu_Vollstaendig_Renoviert",
"log_Vollstaendig_Renoviert",
"log_Vollstaendig_Renoviert_lp_nh_city",
"log_Vollstaendig_Renoviert_mp_nh_city",
"log_Vollstaendig_Renoviert_hp_nh_city",

#"R_obzu_Unbekannter_Zustand",
"log_Unbekannter_Zustand",
"log_Unbekannter_Zustand_lp_nh_city",
"log_Unbekannter_Zustand_mp_nh_city",
"log_Unbekannter_Zustand_hp_nh_city"
)

C1G_reg <- list()
C1E_reg <- list()

C2G_reg <- list()
C2E_reg <- list()

C3G_reg <- list()
C3E_reg <- list()
```


##nrft_n

#models for each controll variable
```{r warning=FALSE}


#lgdppp
###################
c1_g <- list()
c1_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c1 <- att_gt(yname = log_inv_hp_city, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "ft_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~lgdppp,#assen
              data = nrft_n, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c1,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c1,
            type = "dynamic",
            na.rm = T)

#save event study
c1_e[[j]] <- es

#get plot
did_plot_g <- ggdid(gp)

#did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in #quality")) +
 # scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c1_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C1G_reg[["lgdppp"]] <- c1_g
C1E_reg[["lgdppp"]] <- c1_e

```


#lpop
```{r warning=FALSE}


#lpop
###################
c1_g <- list()
c1_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c1 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "ft_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~lpop,#assen
              data = nrft_n, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c1,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c1,
            type = "dynamic",
            na.rm = T)

#save event study
c1_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c1_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C1G_reg[["lpop"]] <- c1_g
C1E_reg[["lpop"]] <- c1_e

```

#lpop_den
```{r warning=FALSE}


#lpopden
###################
c1_g <- list()
c1_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c1 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "ft_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~lpop_den,#assen
              data = nrft_n, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c1,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c1,
            type = "dynamic",
            na.rm = T)

#save event study
c1_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c1_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C1G_reg[["lpop_den"]] <- c1_g
C1E_reg[["lpop_den"]] <- c1_e

```


#rent_sub
```{r warning=FALSE}


#rent_sub
###################
c1_g <- list()
c1_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c1 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "ft_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~rent_sub,#assen
              data = nrft_n, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c1,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c1,
            type = "dynamic",
            na.rm = T)

#save event study
c1_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c1_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C1G_reg[["rent_sub"]] <- c1_g
C1E_reg[["rent_sub"]] <- c1_e

```

#schuldnerquote
```{r warning=FALSE}


#schuldnerquote
###################
c1_g <- list()
c1_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c1 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "ft_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~Schuldnerquote,#assen
              data = nrft_n, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c1,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c1,
            type = "dynamic",
            na.rm = T)

#save event study
c1_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c1_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C1G_reg[["schuldnerquote"]] <- c1_g
C1E_reg[["schuldnerquote"]] <- c1_e

```

#sgb
```{r warning=FALSE}


#sgb
###################
c1_g <- list()
c1_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c1 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "ft_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~sgb,#assen
              data = nrft_n, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c1,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c1,
            type = "dynamic",
            na.rm = T)

#save event study
c1_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c1_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C1G_reg[["sgb"]] <- c1_g
C1E_reg[["sgb"]] <- c1_e

```


#null
```{r warning=FALSE}


#NULL
###################
c1_g <- list()
c1_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c1 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "ft_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =NULL,#assen
              data = nrft_n, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c1,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c1,
            type = "dynamic",
            na.rm = T)

#save event study
c1_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c1_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C1G_reg[["keine"]] <- c1_g
C1E_reg[["keine"]] <- c1_e

list.save(C1E_reg, here("output/c1/C1E_reg.rds"))
list.save(C1G_reg, here("output/c1/C1G_reg.rds"))
```



 
#######ftrr_n
#models for each controll variable
```{r warning=FALSE}


#lgdppp
###################
c2_g <- list()
c2_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c2 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "nta1_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~lgdppp,#assen
              data = ftrr_n, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c2,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c2,
            type = "dynamic",
            na.rm = T)

#save event study
c2_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c2_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C2G_reg[["lgdppp"]] <- c2_g
C2E_reg[["lgdppp"]] <- c2_e

```


#lpop
```{r warning=FALSE}


#lpop
###################
c2_g <- list()
c2_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c2 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "nta1_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~lpop,#assen
              data = ftrr_n, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c2,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c2,
            type = "dynamic",
            na.rm = T)

#save event study
c2_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c2_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C2G_reg[["lpop"]] <- c2_g
C2E_reg[["lpop"]] <- c2_e

```

#lpop_den
```{r warning=FALSE}


#lpopden
###################
c2_g <- list()
c2_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c2 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "nta1_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~lpop_den,#assen
              data = ftrr_n, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c2,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c2,
            type = "dynamic",
            na.rm = T)

#save event study
c2_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c2_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C2G_reg[["lpop_den"]] <- c2_g
C2E_reg[["lpop_den"]] <- c2_e

```


#rent_sub
```{r warning=FALSE}


#rent_sub
###################
c2_g <- list()
c2_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c2 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "nta1_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~rent_sub,#assen
              data = ftrr_n, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c2,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c2,
            type = "dynamic",
            na.rm = T)

#save event study
c2_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c2_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C2G_reg[["rent_sub"]] <- c2_g
C2E_reg[["rent_sub"]] <- c2_e

```

#schuldnerquote
```{r warning=FALSE}


#schuldnerquote
###################
c2_g <- list()
c2_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c2 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "nta1_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~Schuldnerquote,#assen
              data = ftrr_n, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c2,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c2,
            type = "dynamic",
            na.rm = T)

#save event study
c2_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c2_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C2G_reg[["schuldnerquote"]] <- c2_g
C2E_reg[["schuldnerquote"]] <- c2_e

```

#sgb
```{r warning=FALSE}


#sgb
###################
c2_g <- list()
c2_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c2 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "nta1_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~sgb,#assen
              data = ftrr_n, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c2,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c2,
            type = "dynamic",
            na.rm = T)

#save event study
c2_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c2_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C2G_reg[["sgb"]] <- c2_g
C2E_reg[["sgb"]] <- c2_e

```


#null
```{r warning=FALSE}


#NULL
###################
c2_g <- list()
c2_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c2 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "nta1_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =NULL,#assen
              data = ftrr_n, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c2,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c2,
            type = "dynamic",
            na.rm = T)

#save event study
c2_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c2_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}

C2E_reg[["keine"]] <- c2_e
C2G_reg[["keine"]] <- c2_g

list.save(C2E_reg, here("output/c2/C2E_reg.rds"))
list.save(C2G_reg, here("output/c2/C2G_reg.rds"))
```


#rrst_n

#######ftrr_n
#models for each controll variable
```{r warning=FALSE}


#lgdppp
###################
c3_g <- list()
c3_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c3 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "st_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~lgdppp,#assen
              data = rrst_n, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c3,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c3,
            type = "dynamic",
            na.rm = T)

#save event study
c3_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c3_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C3G_reg[["lgdppp"]] <- c3_g
C3E_reg[["lgdppp"]] <- c3_e

```


#lpop
```{r warning=FALSE}


#lpop
###################
c3_g <- list()
c3_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c3 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "st_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~lpop,#assen
              data = rrst_n, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c3,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c3,
            type = "dynamic",
            na.rm = T)

#save event study
c3_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c3_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C3G_reg[["lpop"]] <- c3_g
C3E_reg[["lpop"]] <- c3_e

```

#lpop_den
```{r warning=FALSE}


#lpopden
###################
c3_g <- list()
c3_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c3 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "st_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~lpop_den,#assen
              data = rrst_n, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c3,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c3,
            type = "dynamic",
            na.rm = T)

#save event study
c3_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c3_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C3G_reg[["lpop_den"]] <- c3_g
C3E_reg[["lpop_den"]] <- c3_e

```


#rent_sub
```{r warning=FALSE}


#rent_sub
###################
c3_g <- list()
c3_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c3 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "st_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~rent_sub,#assen
              data = rrst_n, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c3,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c3,
            type = "dynamic",
            na.rm = T)

#save event study
c3_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c3_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C3G_reg[["rent_sub"]] <- c3_g
C3E_reg[["rent_sub"]] <- c3_e

```

#schuldnerquote
```{r warning=FALSE}


#schuldnerquote
###################
c3_g <- list()
c3_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c3 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "st_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~Schuldnerquote,#assen
              data = rrst_n, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c3,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c3,
            type = "dynamic",
            na.rm = T)

#save event study
c3_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c3_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C3G_reg[["schuldnerquote"]] <- c3_g
C3E_reg[["schuldnerquote"]] <- c3_e

```

#sgb
```{r warning=FALSE}


#sgb
###################
c3_g <- list()
c3_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c3 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "st_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~sgb,#assen
              data = rrst_n, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c3,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c3,
            type = "dynamic",
            na.rm = T)

#save event study
c3_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c3_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C3G_reg[["sgb"]] <- c3_g
C3E_reg[["sgb"]] <- c3_e

```


#null
```{r warning=FALSE}


#NULL
###################
c3_g <- list()
c3_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c3 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "st_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =NULL,#assen
              data = rrst_n, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c3,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c3,
            type = "dynamic",
            na.rm = T)

#save event study
c3_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c3_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C3G_reg[["keine"]] <- c3_g
C3E_reg[["keine"]] <- c3_e

list.save(C3E_reg, here("output/c3/C3E_reg.rds"))
list.save(C3G_reg, here("output/c3/C3G_reg.rds"))
```


```{r}




log_ratios <- c(
#overall investment
"log_inv_hp_city" ,
"log_inv_mp_city", 
"log_inv_lp_city",
"log_inv_tc",
  
"log_Abbruchreif",
"log_Abbruchreif",
"log_Abbruchreif_lp_nh_city",
"log_Abbruchreif_mp_nh_city",
"log_Abbruchreif_hp_nh_city",

#"R_obzu_Erstbezug",
"log_Erstbezug",
"log_Erstbezug_lp_nh_city" ,
"log_Erstbezug_mp_nh_city",
"log_Erstbezug_hp_nh_city",

#Erstbezug_nach_Sanierung
"log_Erstbezug_nach_Sanierung",
"log_Erstbezug_nach_Sanierung_lp_nh_city",
"log_Erstbezug_nach_Sanierung_mp_nh_city",
"log_Erstbezug_nach_Sanierung_hp_nh_city",

#"R_obzu_Gepflegt",
"log_Gepflegt",
"log_Gepflegt_lp_nh_city",
"log_Gepflegt_mp_nh_city" ,
"log_Gepflegt_hp_nh_city" ,

#Modernisiert
"log_Modernisiert",
"log_Modernisiert_lp_nh_city",
"log_Modernisiert_mp_nh_city" ,
"log_Modernisiert_hp_nh_city",

#"R_obzu_Nach_Vereinbarung",
"log_Nach_Vereinbarung",
"log_Nach_Vereinbarung_lp_nh_city",
"log_Nach_Vereinbarung_mp_nh_city",
"log_Nach_Vereinbarung_hp_nh_city",

#"R_obzu_Neuwertig",
"log_Neuwertig",
"log_Neuwertig_lp_nh_city",
"log_Neuwertig_mp_nh_city",
"log_Neuwertig_hp_nh_city",

#renovierungsbeduerftig
"log_Renovierungsbeduerftig",
"log_Renovierungsbeduerftig_lp_nh_city",
"log_Renovierungsbeduerftig_mp_nh_city",
"log_Renovierungsbeduerftig_hp_nh_city",

#saniert
"log_saniert",
"log_saniert_lp_nh_city",
"log_saniert_mp_nh_city",
"log_saniert_hp_nh_city",

#"R_obzu_Vollstaendig_Renoviert",
"log_Vollstaendig_Renoviert",
"log_Vollstaendig_Renoviert_lp_nh_city",
"log_Vollstaendig_Renoviert_mp_nh_city",
"log_Vollstaendig_Renoviert_hp_nh_city",

#"R_obzu_Unbekannter_Zustand",
"log_Unbekannter_Zustand",
"log_Unbekannter_Zustand_lp_nh_city",
"log_Unbekannter_Zustand_mp_nh_city",
"log_Unbekannter_Zustand_hp_nh_city"
)

cvars <- c("lgdppp",
           "lpop_den",
           "lpop",
           "rent_sub",
           "schuldnerquote",
           "sgb",
           "keine"
           )

#create result data set

# group effects

#nrft_n

MODELS <- list()
for (q in cvars) {
  for (j in log_ratios) {
    m_dt <- list()
    #extract values and save in matrix
    att <- C1E_reg[[q]][[j]]$overall.att
    se <- C1E_reg[[q]][[j]]$overall.se
    type <- C1E_reg[[q]][[j]]$type
    gname <- C1E_reg[[q]][[j]][["DIDparams"]][["gname"]]#comparison
    N <- C1E_reg[[q]][[j]][["DIDparams"]][["n"]]# N
    est_m <- C1E_reg[[q]][[j]][["DIDparams"]][["call"]][["est_method"]]#estimator
    y_name <- C1E_reg[[q]][[j]][["DIDparams"]][["DIDparams"]][["yname"]]
    cont_v <- C1E_reg[[q]][[j]][["DIDparams"]][["DIDparams"]][["xformla"]][[2]]
    m_dt[["c_var"]] <- cont_v
    m_dt[["dep_var"]] <- y_name
    m_dt[["ATT"]] <- att
    m_dt[["SE"]] <- se
    m_dt[["CV"]] <- qt(0.975,df= N-1)
    m_dt[["type"]] <- type
    m_dt[["gname"]] <- gname
    m_dt[["N"]] <- N
    m_dt[["est_m"]] <- est_m
    
    MODELS[[paste0(j,"_",q)]] <- m_dt
  }
}

df_MODEL <- as.data.frame(do.call(rbind, MODELS))
df_MODEL <- tibble::rownames_to_column(df_MODEL, "row_names")


df_MODEL$CV <- as.numeric(df_MODEL$CV)
df_MODEL$SE <- as.numeric(df_MODEL$SE)
df_MODEL$ATT <- as.numeric(df_MODEL$ATT)

#clean columnes
df_MODEL$N <- as.numeric(df_MODEL$N)
df_MODEL$low_conf <- df_MODEL$ATT - (df_MODEL$CV * df_MODEL$SE)
df_MODEL$up_conf<- df_MODEL$ATT + (df_MODEL$CV * df_MODEL$SE)

df_nrft_n <- df_MODEL
#calculate confidence intervalls



#ftrr_n

MODELS <- list()
for (q in cvars) {
  for (j in log_ratios) {
    m_dt <- list()
    #extract values and save in matrix
    att <- C2E_reg[[q]][[j]]$overall.att
    se <- C2E_reg[[q]][[j]]$overall.se
    type <- C2E_reg[[q]][[j]]$type
    gname <- C2E_reg[[q]][[j]][["DIDparams"]][["gname"]]#comparison
    N <- C2E_reg[[q]][[j]][["DIDparams"]][["n"]]# N
    est_m <- C2E_reg[[q]][[j]][["DIDparams"]][["call"]][["est_method"]]#estimator
    y_name <- C2E_reg[[q]][[j]][["DIDparams"]][["DIDparams"]][["yname"]]
    cont_v <- C2E_reg[[q]][[j]][["DIDparams"]][["DIDparams"]][["xformla"]][[2]]
    m_dt[["c_var"]] <- cont_v
    m_dt[["dep_var"]] <- y_name
    m_dt[["ATT"]] <- att
    m_dt[["SE"]] <- se
    m_dt[["CV"]] <- qt(0.975,df= N-1)
    m_dt[["type"]] <- type
    m_dt[["gname"]] <- gname
    m_dt[["N"]] <- N
    m_dt[["est_m"]] <- est_m
    
    MODELS[[paste0(j,"_",q)]] <- m_dt
  }
}

df_MODEL <- as.data.frame(do.call(rbind, MODELS))
df_MODEL <- tibble::rownames_to_column(df_MODEL, "row_names")


df_MODEL$CV <- as.numeric(df_MODEL$CV)
df_MODEL$SE <- as.numeric(df_MODEL$SE)
df_MODEL$ATT <- as.numeric(df_MODEL$ATT)

#clean columnes
df_MODEL$N <- as.numeric(df_MODEL$N)
df_MODEL$low_conf <- df_MODEL$ATT - (df_MODEL$CV * df_MODEL$SE)
df_MODEL$up_conf<- df_MODEL$ATT + (df_MODEL$CV * df_MODEL$SE)

df_ftrr_n <- df_MODEL


#rrst_n
MODELS <- list()
for (q in cvars) {
  for (j in log_ratios) {
    m_dt <- list()
    #extract values and save in matrix
    att <- C3E_reg[[q]][[j]]$overall.att
    se <- C3E_reg[[q]][[j]]$overall.se
    type <- C3E_reg[[q]][[j]]$type
    gname <- C3E_reg[[q]][[j]][["DIDparams"]][["gname"]]#comparison
    N <- C3E_reg[[q]][[j]][["DIDparams"]][["n"]]# N
    est_m <- C3E_reg[[q]][[j]][["DIDparams"]][["call"]][["est_method"]]#estimator
    y_name <- C3E_reg[[q]][[j]][["DIDparams"]][["DIDparams"]][["yname"]]
    cont_v <- C3E_reg[[q]][[j]][["DIDparams"]][["DIDparams"]][["xformla"]][[2]]
    m_dt[["c_var"]] <- cont_v
    m_dt[["dep_var"]] <- y_name
    m_dt[["ATT"]] <- att
    m_dt[["SE"]] <- se
    m_dt[["CV"]] <- qt(0.975,df= N-1)
    m_dt[["type"]] <- type
    m_dt[["gname"]] <- gname
    m_dt[["N"]] <- N
    m_dt[["est_m"]] <- est_m
    
    MODELS[[paste0(j,"_",q)]] <- m_dt
  }
}

df_MODEL <- as.data.frame(do.call(rbind, MODELS))
df_MODEL <- tibble::rownames_to_column(df_MODEL, "row_names")


df_MODEL$CV <- as.numeric(df_MODEL$CV)
df_MODEL$SE <- as.numeric(df_MODEL$SE)
df_MODEL$ATT <- as.numeric(df_MODEL$ATT)

#clean columnes
df_MODEL$N <- as.numeric(df_MODEL$N)
df_MODEL$low_conf <- df_MODEL$ATT - (df_MODEL$CV * df_MODEL$SE)
df_MODEL$up_conf<- df_MODEL$ATT + (df_MODEL$CV * df_MODEL$SE)

df_rrst_n <- df_MODEL



```


```{r}

#bind all singel modells for the different comparisons
df_RC_E <- rbind(df_nrft_n, df_ftrr_n)
df_RC_E <- rbind(df_RC_E, df_rrst_n)
```


# data set for event study overall att 
```{r}
# group effects

#nrft_n

MODELS <- list()
for (q in cvars) {
  for (j in log_ratios) {
    m_dt <- list()
    #extract values and save in matrix
    att <- C1G_reg[[q]][[j]]$overall.att
    se <- C1G_reg[[q]][[j]]$overall.se
    type <- C1G_reg[[q]][[j]]$type
    gname <- C1G_reg[[q]][[j]][["DIDparams"]][["gname"]]#comparison
    N <- C1G_reg[[q]][[j]][["DIDparams"]][["n"]]# N
    est_m <- C1G_reg[[q]][[j]][["DIDparams"]][["call"]][["est_method"]]#estimator
    y_name <- C1G_reg[[q]][[j]][["DIDparams"]][["DIDparams"]][["yname"]]
    cont_v <- C1G_reg[[q]][[j]][["DIDparams"]][["DIDparams"]][["xformla"]][[2]]
    m_dt[["c_var"]] <- cont_v
    m_dt[["dep_var"]] <- y_name
    m_dt[["ATT"]] <- att
    m_dt[["SE"]] <- se
    m_dt[["CV"]] <- qt(0.975,df= N-1)
    m_dt[["type"]] <- type
    m_dt[["gname"]] <- gname
    m_dt[["N"]] <- N
    m_dt[["est_m"]] <- est_m
    
    MODELS[[paste0(j,"_",q)]] <- m_dt
  }
}

df_MODEL <- as.data.frame(do.call(rbind, MODELS))
df_MODEL <- tibble::rownames_to_column(df_MODEL, "row_names")


df_MODEL$CV <- as.numeric(df_MODEL$CV)
df_MODEL$SE <- as.numeric(df_MODEL$SE)
df_MODEL$ATT <- as.numeric(df_MODEL$ATT)

#clean columnes
df_MODEL$N <- as.numeric(df_MODEL$N)
df_MODEL$low_conf <- df_MODEL$ATT - (df_MODEL$CV * df_MODEL$SE)
df_MODEL$up_conf<- df_MODEL$ATT + (df_MODEL$CV * df_MODEL$SE)

df_nrft_n <- df_MODEL
#calculate confidence intervalls



#ftrr_n

MODELS <- list()
for (q in cvars) {
  for (j in log_ratios) {
    m_dt <- list()
    #extract values and save in matrix
    att <- C2G_reg[[q]][[j]]$overall.att
    se <- C2G_reg[[q]][[j]]$overall.se
    type <- C2G_reg[[q]][[j]]$type
    gname <- C2G_reg[[q]][[j]][["DIDparams"]][["gname"]]#comparison
    N <- C2G_reg[[q]][[j]][["DIDparams"]][["n"]]# N
    est_m <- C2G_reg[[q]][[j]][["DIDparams"]][["call"]][["est_method"]]#estimator
    y_name <- C2G_reg[[q]][[j]][["DIDparams"]][["DIDparams"]][["yname"]]
    cont_v <- C2G_reg[[q]][[j]][["DIDparams"]][["DIDparams"]][["xformla"]][[2]]
    m_dt[["c_var"]] <- cont_v
    m_dt[["dep_var"]] <- y_name
    m_dt[["ATT"]] <- att
    m_dt[["SE"]] <- se
    m_dt[["CV"]] <- qt(0.975,df= N-1)
    m_dt[["type"]] <- type
    m_dt[["gname"]] <- gname
    m_dt[["N"]] <- N
    m_dt[["est_m"]] <- est_m
    
    MODELS[[paste0(j,"_",q)]] <- m_dt
  }
}

df_MODEL <- as.data.frame(do.call(rbind, MODELS))
df_MODEL <- tibble::rownames_to_column(df_MODEL, "row_names")


df_MODEL$CV <- as.numeric(df_MODEL$CV)
df_MODEL$SE <- as.numeric(df_MODEL$SE)
df_MODEL$ATT <- as.numeric(df_MODEL$ATT)

#clean columnes
df_MODEL$N <- as.numeric(df_MODEL$N)
df_MODEL$low_conf <- df_MODEL$ATT - (df_MODEL$CV * df_MODEL$SE)
df_MODEL$up_conf<- df_MODEL$ATT + (df_MODEL$CV * df_MODEL$SE)

df_ftrr_n <- df_MODEL


#rrst_n
MODELS <- list()
for (q in cvars) {
  for (j in log_ratios) {
    m_dt <- list()
    #extract values and save in matrix
    att <- C3G_reg[[q]][[j]]$overall.att
    se <- C3G_reg[[q]][[j]]$overall.se
    type <- C3G_reg[[q]][[j]]$type
    gname <- C3G_reg[[q]][[j]][["DIDparams"]][["gname"]]#comparison
    N <- C3G_reg[[q]][[j]][["DIDparams"]][["n"]]# N
    est_m <- C3G_reg[[q]][[j]][["DIDparams"]][["call"]][["est_method"]]#estimator
    y_name <- C3G_reg[[q]][[j]][["DIDparams"]][["DIDparams"]][["yname"]]
    cont_v <- C3G_reg[[q]][[j]][["DIDparams"]][["DIDparams"]][["xformla"]][[2]]
    m_dt[["c_var"]] <- cont_v
    m_dt[["dep_var"]] <- y_name
    m_dt[["ATT"]] <- att
    m_dt[["SE"]] <- se
    m_dt[["CV"]] <- qt(0.975,df= N-1)
    m_dt[["type"]] <- type
    m_dt[["gname"]] <- gname
    m_dt[["N"]] <- N
    m_dt[["est_m"]] <- est_m
    
    MODELS[[paste0(j,"_",q)]] <- m_dt
  }
}

df_MODEL <- as.data.frame(do.call(rbind, MODELS))
df_MODEL <- tibble::rownames_to_column(df_MODEL, "row_names")


df_MODEL$CV <- as.numeric(df_MODEL$CV)
df_MODEL$SE <- as.numeric(df_MODEL$SE)
df_MODEL$ATT <- as.numeric(df_MODEL$ATT)

#clean columnes
df_MODEL$N <- as.numeric(df_MODEL$N)
df_MODEL$low_conf <- df_MODEL$ATT - (df_MODEL$CV * df_MODEL$SE)
df_MODEL$up_conf<- df_MODEL$ATT + (df_MODEL$CV * df_MODEL$SE)

df_rrst_n <- df_MODEL





```
 
```{r}

#bind all singel modells for the different comparisons
df_RC_G <- rbind(df_nrft_n, df_ftrr_n)
df_RC_G <- rbind(df_RC_G, df_rrst_n)
```


```{r}



#save all models
#fwrite(df_nrft_n, "df_nrft_n.csv")
#fwrite(df_ftrr_n, "df_ftrr_n.csv")
#fwrite(df_rrst_n, "df_rrst_n.csv")

```


```{r}

#get columne for signifikance

#bind all singel modells for the different comparisons
df_RC_reg_n <- rbind(df_RC_G, df_RC_E)

#get new columne for att positive or negativ
df_RC_reg_n <- df_RC_reg_n%>% 
  mutate(
   p_n = case_when(
      ATT > 0 ~ "+",
      ATT < 0 ~ "-"
    ))


df_RC_reg_n <- df_RC_reg_n%>%mutate(
  sig_5 = case_when(
   p_n == "-" & 0 > up_conf ~ "*",
   p_n == "+" & 0 < low_conf ~ "*"
  )
)



#only significnat models
sig5_model_reg <- df_RC_reg_n%>%filter(is.na(sig_5)==F)

#get columne for control vars
df_RC_reg_n$c_var <- gsub(".*_", "", df_RC_reg_n$row_names)

df_RC_reg_n$type <- as.character(df_RC_reg_n$type)
df_RC_reg_n$gname <- as.character(df_RC_reg_n$gname)
df_RC_reg_n$est_m <- as.character(df_RC_reg_n$est_m)

df_RC_reg_n<-unique(df_RC_reg_n)

#####get more significanc levels

#significant on 1% level**
#get critical value for 1% level
df_RC_reg_n$cv_99 <- qt(0.995,df= df_RC_reg_n$N-1)
#get confidence interval
df_RC_reg_n$low_conf_99 <- df_RC_reg_n$ATT - (df_RC_reg_n$cv_99 * df_RC_reg_n$SE)
df_RC_reg_n$up_conf_99<- df_RC_reg_n$ATT + (df_RC_reg_n$cv_99 * df_RC_reg_n$SE)
#mark the significant models with two stars**
df_RC_reg_n <- df_RC_reg_n%>%mutate(
  sig_1 = case_when(
   p_n == "-" & 0 > up_conf_99 ~ "**",
   p_n == "+" & 0 < low_conf_99 ~ "**"
  )
)


#significant on 0,1% level***
#get critical value for 0,1% level
df_RC_reg_n$cv_0.1 <- qt(0.9995,df= df_RC_reg_n$N-1)
#get confidenc interval
df_RC_reg_n$low_conf_0.1 <- df_RC_reg_n$ATT - (df_RC_reg_n$cv_0.1 * df_RC_reg_n$SE)
df_RC_reg_n$up_conf_0.1<- df_RC_reg_n$ATT + (df_RC_reg_n$cv_0.1 * df_RC_reg_n$SE)
#mark the significant models with three stars***
df_RC_reg_n <- df_RC_reg_n%>%mutate(
  sig_0.1 = case_when(
   p_n == "-" & 0 > up_conf_0.1 ~ "***",
   p_n == "+" & 0 < low_conf_0.1 ~ "***"
  )
)


#save data set with all calculated models
write_xlsx(df_RC_reg_n, "~/rent_control/output/DF_reg_n_models.xlsx")
fwrite(df_RC_reg_n, "df_RC_reg_n.csv")
```



# robustness check: south models

```{r}

#control group: no rent control; treatment group: rent control first time
nrft <- m10_rd %>% filter(TG==1 | TG==0) 
nrft_s <- nrft %>% filter(is.na(south)==F) 

#control group: rent control first time; treatment group: repealed rent control
ftrr <- m10_rd %>% filter(TG==1 | TG==3) 
ftrr_s <- ftrr %>% filter(is.na(south)==F) 
#control group: repealed rent control; treatment group: rent control second time
rrst <- m10_rd %>% filter(TG==3 | TG==2) 
rrst_s <- rrst %>% filter(is.na(south)==F) 
```



var
```{r}


log_ratios <- c(
#overall investment
"log_inv_hp_city" ,
"log_inv_mp_city", 
"log_inv_lp_city",
"log_inv_tc",
  
#"R_obzu_Abbruchreif",
"log_Abbruchreif",
"log_Abbruchreif_lp_nh_city",
"log_Abbruchreif_mp_nh_city",
"log_Abbruchreif_hp_nh_city",

#"R_obzu_Erstbezug",
"log_Erstbezug",
"log_Erstbezug_lp_nh_city" ,
"log_Erstbezug_mp_nh_city",
"log_Erstbezug_hp_nh_city",

#Erstbezug_nach_Sanierung
"log_Erstbezug_nach_Sanierung",
"log_Erstbezug_nach_Sanierung_lp_nh_city",
"log_Erstbezug_nach_Sanierung_mp_nh_city",
"log_Erstbezug_nach_Sanierung_hp_nh_city",

#"R_obzu_Gepflegt",
"log_Gepflegt",
"log_Gepflegt_lp_nh_city",
"log_Gepflegt_mp_nh_city" ,
"log_Gepflegt_hp_nh_city" ,

#Modernisiert
"log_Modernisiert",
"log_Modernisiert_lp_nh_city",
"log_Modernisiert_mp_nh_city" ,
"log_Modernisiert_hp_nh_city",

#"R_obzu_Nach_Vereinbarung",
"log_Nach_Vereinbarung",
"log_Nach_Vereinbarung_lp_nh_city",
"log_Nach_Vereinbarung_mp_nh_city",
"log_Nach_Vereinbarung_hp_nh_city",

#"R_obzu_Neuwertig",
"log_Neuwertig",
"log_Neuwertig_lp_nh_city",
"log_Neuwertig_mp_nh_city",
"log_Neuwertig_hp_nh_city",

#renovierungsbeduerftig
"log_Renovierungsbeduerftig",
"log_Renovierungsbeduerftig_lp_nh_city",
"log_Renovierungsbeduerftig_mp_nh_city",
"log_Renovierungsbeduerftig_hp_nh_city",

#saniert
"log_saniert",
"log_saniert_lp_nh_city",
"log_saniert_mp_nh_city",
"log_saniert_hp_nh_city",

#"R_obzu_Vollstaendig_Renoviert",
"log_Vollstaendig_Renoviert",
"log_Vollstaendig_Renoviert_lp_nh_city",
"log_Vollstaendig_Renoviert_mp_nh_city",
"log_Vollstaendig_Renoviert_hp_nh_city",

#"R_obzu_Unbekannter_Zustand",
"log_Unbekannter_Zustand",
"log_Unbekannter_Zustand_lp_nh_city",
"log_Unbekannter_Zustand_mp_nh_city",
"log_Unbekannter_Zustand_hp_nh_city"
)

C1G_reg <- list()
C1E_reg <- list()

C2G_reg <- list()
C2E_reg <- list()

C3G_reg <- list()
C3E_reg <- list()
```


##nrft_s

#models for each controll variable
```{r warning=FALSE}


#lgdppp
###################
c1_g <- list()
c1_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c1 <- att_gt(yname = log_inv_hp_city, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "ft_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~lgdppp,#assen
              data = nrft_s, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c1,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c1,
            type = "dynamic",
            na.rm = T)

#save event study
c1_e[[j]] <- es

#get plot
did_plot_g <- ggdid(gp)

#did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in #quality")) +
 # scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c1_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C1G_reg[["lgdppp"]] <- c1_g
C1E_reg[["lgdppp"]] <- c1_e

```


#lpop
```{r warning=FALSE}


#lpop
###################
c1_g <- list()
c1_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c1 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "ft_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~lpop,#assen
              data = nrft_s, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c1,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c1,
            type = "dynamic",
            na.rm = T)

#save event study
c1_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c1_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C1G_reg[["lpop"]] <- c1_g
C1E_reg[["lpop"]] <- c1_e

```

#lpop_den
```{r warning=FALSE}


#lpopden
###################
c1_g <- list()
c1_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c1 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "ft_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~lpop_den,#assen
              data = nrft_s, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c1,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c1,
            type = "dynamic",
            na.rm = T)

#save event study
c1_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c1_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C1G_reg[["lpop_den"]] <- c1_g
C1E_reg[["lpop_den"]] <- c1_e

```


#rent_sub
```{r warning=FALSE}


#rent_sub
###################
c1_g <- list()
c1_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c1 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "ft_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~rent_sub,#assen
              data = nrft_s, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c1,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c1,
            type = "dynamic",
            na.rm = T)

#save event study
c1_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c1_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C1G_reg[["rent_sub"]] <- c1_g
C1E_reg[["rent_sub"]] <- c1_e

```

#schuldnerquote
```{r warning=FALSE}


#schuldnerquote
###################
c1_g <- list()
c1_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c1 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "ft_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~Schuldnerquote,#assen
              data = nrft_s, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c1,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c1,
            type = "dynamic",
            na.rm = T)

#save event study
c1_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c1_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C1G_reg[["schuldnerquote"]] <- c1_g
C1E_reg[["schuldnerquote"]] <- c1_e

```

#sgb
```{r warning=FALSE}


#sgb
###################
c1_g <- list()
c1_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c1 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "ft_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~sgb,#assen
              data = nrft_s, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c1,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c1,
            type = "dynamic",
            na.rm = T)

#save event study
c1_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c1_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C1G_reg[["sgb"]] <- c1_g
C1E_reg[["sgb"]] <- c1_e

```


#null
```{r warning=FALSE}


#NULL
###################
c1_g <- list()
c1_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c1 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "ft_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =NULL,#assen
              data = nrft_s, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c1,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c1,
            type = "dynamic",
            na.rm = T)

#save event study
c1_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c1_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C1G_reg[["keine"]] <- c1_g
C1E_reg[["keine"]] <- c1_e

list.save(C1E_reg, here("output/c1/C1E_reg.rds"))
list.save(C1G_reg, here("output/c1/C1G_reg.rds"))
```



 
#######ftrr_s
#models for each controll variable
```{r warning=FALSE}


#lgdppp
###################
c2_g <- list()
c2_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c2 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "nta1_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~lgdppp,#assen
              data = ftrr_s, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c2,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c2,
            type = "dynamic",
            na.rm = T)

#save event study
c2_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c2_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C2G_reg[["lgdppp"]] <- c2_g
C2E_reg[["lgdppp"]] <- c2_e

```


#lpop
```{r warning=FALSE}


#lpop
###################
c2_g <- list()
c2_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c2 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "nta1_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~lpop,#assen
              data = ftrr_s, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c2,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c2,
            type = "dynamic",
            na.rm = T)

#save event study
c2_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c2_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C2G_reg[["lpop"]] <- c2_g
C2E_reg[["lpop"]] <- c2_e

```

#lpop_den
```{r warning=FALSE}


#lpopden
###################
c2_g <- list()
c2_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c2 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "nta1_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~lpop_den,#assen
              data = ftrr_s, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c2,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c2,
            type = "dynamic",
            na.rm = T)

#save event study
c2_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c2_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C2G_reg[["lpop_den"]] <- c2_g
C2E_reg[["lpop_den"]] <- c2_e

```


#rent_sub
```{r warning=FALSE}


#rent_sub
###################
c2_g <- list()
c2_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c2 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "nta1_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~rent_sub,#assen
              data = ftrr_s, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c2,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c2,
            type = "dynamic",
            na.rm = T)

#save event study
c2_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c2_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C2G_reg[["rent_sub"]] <- c2_g
C2E_reg[["rent_sub"]] <- c2_e

```

#schuldnerquote
```{r warning=FALSE}


#schuldnerquote
###################
c2_g <- list()
c2_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c2 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "nta1_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~Schuldnerquote,#assen
              data = ftrr_s, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c2,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c2,
            type = "dynamic",
            na.rm = T)

#save event study
c2_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c2_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C2G_reg[["schuldnerquote"]] <- c2_g
C2E_reg[["schuldnerquote"]] <- c2_e

```

#sgb
```{r warning=FALSE}


#sgb
###################
c2_g <- list()
c2_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c2 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "nta1_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~sgb,#assen
              data = ftrr_s, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c2,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c2,
            type = "dynamic",
            na.rm = T)

#save event study
c2_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c2_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C2G_reg[["sgb"]] <- c2_g
C2E_reg[["sgb"]] <- c2_e

```


#null
```{r warning=FALSE}


#NULL
###################
c2_g <- list()
c2_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c2 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "nta1_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =NULL,#assen
              data = ftrr_s, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c2,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c2,
            type = "dynamic",
            na.rm = T)

#save event study
c2_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c2_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}

C2E_reg[["keine"]] <- c2_e
C2G_reg[["keine"]] <- c2_g

list.save(C2E_reg, here("output/c2/C2E_reg.rds"))
list.save(C2G_reg, here("output/c2/C2G_reg.rds"))
```


#rrst_s

#######ftrr_s
#models for each controll variable
```{r warning=FALSE}


#lgdppp
###################
c3_g <- list()
c3_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c3 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "st_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~lgdppp,#assen
              data = rrst_s, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c3,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c3,
            type = "dynamic",
            na.rm = T)

#save event study
c3_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c3_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C3G_reg[["lgdppp"]] <- c3_g
C3E_reg[["lgdppp"]] <- c3_e

```


#lpop
```{r warning=FALSE}


#lpop
###################
c3_g <- list()
c3_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c3 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "st_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~lpop,#assen
              data = rrst_s, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c3,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c3,
            type = "dynamic",
            na.rm = T)

#save event study
c3_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c3_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C3G_reg[["lpop"]] <- c3_g
C3E_reg[["lpop"]] <- c3_e

```

#lpop_den
```{r warning=FALSE}


#lpopden
###################
c3_g <- list()
c3_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c3 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "st_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~lpop_den,#assen
              data = rrst_s, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c3,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c3,
            type = "dynamic",
            na.rm = T)

#save event study
c3_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c3_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C3G_reg[["lpop_den"]] <- c3_g
C3E_reg[["lpop_den"]] <- c3_e

```


#rent_sub
```{r warning=FALSE}


#rent_sub
###################
c3_g <- list()
c3_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c3 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "st_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~rent_sub,#assen
              data = rrst_s, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c3,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c3,
            type = "dynamic",
            na.rm = T)

#save event study
c3_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c3_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C3G_reg[["rent_sub"]] <- c3_g
C3E_reg[["rent_sub"]] <- c3_e

```

#schuldnerquote
```{r warning=FALSE}


#schuldnerquote
###################
c3_g <- list()
c3_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c3 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "st_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~Schuldnerquote,#assen
              data = rrst_s, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c3,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c3,
            type = "dynamic",
            na.rm = T)

#save event study
c3_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c3_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C3G_reg[["schuldnerquote"]] <- c3_g
C3E_reg[["schuldnerquote"]] <- c3_e

```

#sgb
```{r warning=FALSE}


#sgb
###################
c3_g <- list()
c3_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c3 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "st_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =~sgb,#assen
              data = rrst_s, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c3,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c3,
            type = "dynamic",
            na.rm = T)

#save event study
c3_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c3_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C3G_reg[["sgb"]] <- c3_g
C3E_reg[["sgb"]] <- c3_e

```


#null
```{r warning=FALSE}


#NULL
###################
c3_g <- list()
c3_e <- list()

for (j in log_ratios) {
  tryCatch({
    
#estimate: Group-Time Average Treatment Effects    
attgt_c3 <- att_gt(yname = j, #anpassen
              tname = "t_periode", 
              idname = "gid2015",
              gname = "st_periode",#anpassen
              allow_unbalanced_panel =T,
              xformla =NULL,#assen
              data = rrst_s, #anpassen
              control_group="notyettreated",
              est_method = "reg",
              alp = 0.05
              )


#group
gp <- aggte(attgt_c3,
            type = "group",
            na.rm = T)
   
#event study
es <- aggte(attgt_c3,
            type = "dynamic",
            na.rm = T)

#save event study
c3_e[[j]] <- es

#get plot
did_plot <- ggdid(gp)

did_plot <- did_plot +ggtitle( paste0("Rent control (first time)\ndependent var: log flats in expensive neighbourhoods\nwith investment in quality")) +
  scale_x_continuous(breaks=seq(-300, 300, 20))

#save plots
c3_g[[j]] <- gp

  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  print(j)
}
  
C3G_reg[["keine"]] <- c3_g
C3E_reg[["keine"]] <- c3_e

list.save(C3E_reg, here("output/c3/C3E_reg.rds"))
list.save(C3G_reg, here("output/c3/C3G_reg.rds"))
```


```{r}




log_ratios <- c(
#overall investment
"log_inv_hp_city" ,
"log_inv_mp_city", 
"log_inv_lp_city",
"log_inv_tc",
  
"log_Abbruchreif",
"log_Abbruchreif",
"log_Abbruchreif_lp_nh_city",
"log_Abbruchreif_mp_nh_city",
"log_Abbruchreif_hp_nh_city",

#"R_obzu_Erstbezug",
"log_Erstbezug",
"log_Erstbezug_lp_nh_city" ,
"log_Erstbezug_mp_nh_city",
"log_Erstbezug_hp_nh_city",

#Erstbezug_nach_Sanierung
"log_Erstbezug_nach_Sanierung",
"log_Erstbezug_nach_Sanierung_lp_nh_city",
"log_Erstbezug_nach_Sanierung_mp_nh_city",
"log_Erstbezug_nach_Sanierung_hp_nh_city",

#"R_obzu_Gepflegt",
"log_Gepflegt",
"log_Gepflegt_lp_nh_city",
"log_Gepflegt_mp_nh_city" ,
"log_Gepflegt_hp_nh_city" ,

#Modernisiert
"log_Modernisiert",
"log_Modernisiert_lp_nh_city",
"log_Modernisiert_mp_nh_city" ,
"log_Modernisiert_hp_nh_city",

#"R_obzu_Nach_Vereinbarung",
"log_Nach_Vereinbarung",
"log_Nach_Vereinbarung_lp_nh_city",
"log_Nach_Vereinbarung_mp_nh_city",
"log_Nach_Vereinbarung_hp_nh_city",

#"R_obzu_Neuwertig",
"log_Neuwertig",
"log_Neuwertig_lp_nh_city",
"log_Neuwertig_mp_nh_city",
"log_Neuwertig_hp_nh_city",

#renovierungsbeduerftig
"log_Renovierungsbeduerftig",
"log_Renovierungsbeduerftig_lp_nh_city",
"log_Renovierungsbeduerftig_mp_nh_city",
"log_Renovierungsbeduerftig_hp_nh_city",

#saniert
"log_saniert",
"log_saniert_lp_nh_city",
"log_saniert_mp_nh_city",
"log_saniert_hp_nh_city",

#"R_obzu_Vollstaendig_Renoviert",
"log_Vollstaendig_Renoviert",
"log_Vollstaendig_Renoviert_lp_nh_city",
"log_Vollstaendig_Renoviert_mp_nh_city",
"log_Vollstaendig_Renoviert_hp_nh_city",

#"R_obzu_Unbekannter_Zustand",
"log_Unbekannter_Zustand",
"log_Unbekannter_Zustand_lp_nh_city",
"log_Unbekannter_Zustand_mp_nh_city",
"log_Unbekannter_Zustand_hp_nh_city"
)

cvars <- c("lgdppp",
           "lpop_den",
           "lpop",
           "rent_sub",
           "schuldnerquote",
           "sgb",
           "keine"
           )

#create result data set

# group effects

#nrft_s

MODELS <- list()
for (q in cvars) {
  for (j in log_ratios) {
    m_dt <- list()
    #extract values and save in matrix
    att <- C1E_reg[[q]][[j]]$overall.att
    se <- C1E_reg[[q]][[j]]$overall.se
    type <- C1E_reg[[q]][[j]]$type
    gname <- C1E_reg[[q]][[j]][["DIDparams"]][["gname"]]#comparison
    N <- C1E_reg[[q]][[j]][["DIDparams"]][["n"]]# N
    est_m <- C1E_reg[[q]][[j]][["DIDparams"]][["call"]][["est_method"]]#estimator
    y_name <- C1E_reg[[q]][[j]][["DIDparams"]][["DIDparams"]][["yname"]]
    cont_v <- C1E_reg[[q]][[j]][["DIDparams"]][["DIDparams"]][["xformla"]][[2]]
    m_dt[["c_var"]] <- cont_v
    m_dt[["dep_var"]] <- y_name
    m_dt[["ATT"]] <- att
    m_dt[["SE"]] <- se
    m_dt[["CV"]] <- qt(0.975,df= N-1)
    m_dt[["type"]] <- type
    m_dt[["gname"]] <- gname
    m_dt[["N"]] <- N
    m_dt[["est_m"]] <- est_m
    
    MODELS[[paste0(j,"_",q)]] <- m_dt
  }
}

df_MODEL <- as.data.frame(do.call(rbind, MODELS))
df_MODEL <- tibble::rownames_to_column(df_MODEL, "row_names")


df_MODEL$CV <- as.numeric(df_MODEL$CV)
df_MODEL$SE <- as.numeric(df_MODEL$SE)
df_MODEL$ATT <- as.numeric(df_MODEL$ATT)

#clean columnes
df_MODEL$N <- as.numeric(df_MODEL$N)
df_MODEL$low_conf <- df_MODEL$ATT - (df_MODEL$CV * df_MODEL$SE)
df_MODEL$up_conf<- df_MODEL$ATT + (df_MODEL$CV * df_MODEL$SE)

df_nrft_s <- df_MODEL
#calculate confidence intervalls



#ftrr_s

MODELS <- list()
for (q in cvars) {
  for (j in log_ratios) {
    m_dt <- list()
    #extract values and save in matrix
    att <- C2E_reg[[q]][[j]]$overall.att
    se <- C2E_reg[[q]][[j]]$overall.se
    type <- C2E_reg[[q]][[j]]$type
    gname <- C2E_reg[[q]][[j]][["DIDparams"]][["gname"]]#comparison
    N <- C2E_reg[[q]][[j]][["DIDparams"]][["n"]]# N
    est_m <- C2E_reg[[q]][[j]][["DIDparams"]][["call"]][["est_method"]]#estimator
    y_name <- C2E_reg[[q]][[j]][["DIDparams"]][["DIDparams"]][["yname"]]
    cont_v <- C2E_reg[[q]][[j]][["DIDparams"]][["DIDparams"]][["xformla"]][[2]]
    m_dt[["c_var"]] <- cont_v
    m_dt[["dep_var"]] <- y_name
    m_dt[["ATT"]] <- att
    m_dt[["SE"]] <- se
    m_dt[["CV"]] <- qt(0.975,df= N-1)
    m_dt[["type"]] <- type
    m_dt[["gname"]] <- gname
    m_dt[["N"]] <- N
    m_dt[["est_m"]] <- est_m
    
    MODELS[[paste0(j,"_",q)]] <- m_dt
  }
}

df_MODEL <- as.data.frame(do.call(rbind, MODELS))
df_MODEL <- tibble::rownames_to_column(df_MODEL, "row_names")


df_MODEL$CV <- as.numeric(df_MODEL$CV)
df_MODEL$SE <- as.numeric(df_MODEL$SE)
df_MODEL$ATT <- as.numeric(df_MODEL$ATT)

#clean columnes
df_MODEL$N <- as.numeric(df_MODEL$N)
df_MODEL$low_conf <- df_MODEL$ATT - (df_MODEL$CV * df_MODEL$SE)
df_MODEL$up_conf<- df_MODEL$ATT + (df_MODEL$CV * df_MODEL$SE)

df_ftrr_s <- df_MODEL


#rrst_s
MODELS <- list()
for (q in cvars) {
  for (j in log_ratios) {
    m_dt <- list()
    #extract values and save in matrix
    att <- C3E_reg[[q]][[j]]$overall.att
    se <- C3E_reg[[q]][[j]]$overall.se
    type <- C3E_reg[[q]][[j]]$type
    gname <- C3E_reg[[q]][[j]][["DIDparams"]][["gname"]]#comparison
    N <- C3E_reg[[q]][[j]][["DIDparams"]][["n"]]# N
    est_m <- C3E_reg[[q]][[j]][["DIDparams"]][["call"]][["est_method"]]#estimator
    y_name <- C3E_reg[[q]][[j]][["DIDparams"]][["DIDparams"]][["yname"]]
    cont_v <- C3E_reg[[q]][[j]][["DIDparams"]][["DIDparams"]][["xformla"]][[2]]
    m_dt[["c_var"]] <- cont_v
    m_dt[["dep_var"]] <- y_name
    m_dt[["ATT"]] <- att
    m_dt[["SE"]] <- se
    m_dt[["CV"]] <- qt(0.975,df= N-1)
    m_dt[["type"]] <- type
    m_dt[["gname"]] <- gname
    m_dt[["N"]] <- N
    m_dt[["est_m"]] <- est_m
    
    MODELS[[paste0(j,"_",q)]] <- m_dt
  }
}

df_MODEL <- as.data.frame(do.call(rbind, MODELS))
df_MODEL <- tibble::rownames_to_column(df_MODEL, "row_names")


df_MODEL$CV <- as.numeric(df_MODEL$CV)
df_MODEL$SE <- as.numeric(df_MODEL$SE)
df_MODEL$ATT <- as.numeric(df_MODEL$ATT)

#clean columnes
df_MODEL$N <- as.numeric(df_MODEL$N)
df_MODEL$low_conf <- df_MODEL$ATT - (df_MODEL$CV * df_MODEL$SE)
df_MODEL$up_conf<- df_MODEL$ATT + (df_MODEL$CV * df_MODEL$SE)

df_rrst_s <- df_MODEL



```


```{r}

#bind all singel modells for the different comparisons
df_RC_E <- rbind(df_nrft_s, df_ftrr_s)
df_RC_E <- rbind(df_RC_E, df_rrst_s)
```


# data set for event study overall att 
```{r}
# group effects

#nrft_s

MODELS <- list()
for (q in cvars) {
  for (j in log_ratios) {
    m_dt <- list()
    #extract values and save in matrix
    att <- C1G_reg[[q]][[j]]$overall.att
    se <- C1G_reg[[q]][[j]]$overall.se
    type <- C1G_reg[[q]][[j]]$type
    gname <- C1G_reg[[q]][[j]][["DIDparams"]][["gname"]]#comparison
    N <- C1G_reg[[q]][[j]][["DIDparams"]][["n"]]# N
    est_m <- C1G_reg[[q]][[j]][["DIDparams"]][["call"]][["est_method"]]#estimator
    y_name <- C1G_reg[[q]][[j]][["DIDparams"]][["DIDparams"]][["yname"]]
    cont_v <- C1G_reg[[q]][[j]][["DIDparams"]][["DIDparams"]][["xformla"]][[2]]
    m_dt[["c_var"]] <- cont_v
    m_dt[["dep_var"]] <- y_name
    m_dt[["ATT"]] <- att
    m_dt[["SE"]] <- se
    m_dt[["CV"]] <- qt(0.975,df= N-1)
    m_dt[["type"]] <- type
    m_dt[["gname"]] <- gname
    m_dt[["N"]] <- N
    m_dt[["est_m"]] <- est_m
    
    MODELS[[paste0(j,"_",q)]] <- m_dt
  }
}

df_MODEL <- as.data.frame(do.call(rbind, MODELS))
df_MODEL <- tibble::rownames_to_column(df_MODEL, "row_names")


df_MODEL$CV <- as.numeric(df_MODEL$CV)
df_MODEL$SE <- as.numeric(df_MODEL$SE)
df_MODEL$ATT <- as.numeric(df_MODEL$ATT)

#clean columnes
df_MODEL$N <- as.numeric(df_MODEL$N)
df_MODEL$low_conf <- df_MODEL$ATT - (df_MODEL$CV * df_MODEL$SE)
df_MODEL$up_conf<- df_MODEL$ATT + (df_MODEL$CV * df_MODEL$SE)

df_nrft_s <- df_MODEL
#calculate confidence intervalls



#ftrr_s

MODELS <- list()
for (q in cvars) {
  for (j in log_ratios) {
    m_dt <- list()
    #extract values and save in matrix
    att <- C2G_reg[[q]][[j]]$overall.att
    se <- C2G_reg[[q]][[j]]$overall.se
    type <- C2G_reg[[q]][[j]]$type
    gname <- C2G_reg[[q]][[j]][["DIDparams"]][["gname"]]#comparison
    N <- C2G_reg[[q]][[j]][["DIDparams"]][["n"]]# N
    est_m <- C2G_reg[[q]][[j]][["DIDparams"]][["call"]][["est_method"]]#estimator
    y_name <- C2G_reg[[q]][[j]][["DIDparams"]][["DIDparams"]][["yname"]]
    cont_v <- C2G_reg[[q]][[j]][["DIDparams"]][["DIDparams"]][["xformla"]][[2]]
    m_dt[["c_var"]] <- cont_v
    m_dt[["dep_var"]] <- y_name
    m_dt[["ATT"]] <- att
    m_dt[["SE"]] <- se
    m_dt[["CV"]] <- qt(0.975,df= N-1)
    m_dt[["type"]] <- type
    m_dt[["gname"]] <- gname
    m_dt[["N"]] <- N
    m_dt[["est_m"]] <- est_m
    
    MODELS[[paste0(j,"_",q)]] <- m_dt
  }
}

df_MODEL <- as.data.frame(do.call(rbind, MODELS))
df_MODEL <- tibble::rownames_to_column(df_MODEL, "row_names")


df_MODEL$CV <- as.numeric(df_MODEL$CV)
df_MODEL$SE <- as.numeric(df_MODEL$SE)
df_MODEL$ATT <- as.numeric(df_MODEL$ATT)

#clean columnes
df_MODEL$N <- as.numeric(df_MODEL$N)
df_MODEL$low_conf <- df_MODEL$ATT - (df_MODEL$CV * df_MODEL$SE)
df_MODEL$up_conf<- df_MODEL$ATT + (df_MODEL$CV * df_MODEL$SE)

df_ftrr_s <- df_MODEL


#rrst_s
MODELS <- list()
for (q in cvars) {
  for (j in log_ratios) {
    m_dt <- list()
    #extract values and save in matrix
    att <- C3G_reg[[q]][[j]]$overall.att
    se <- C3G_reg[[q]][[j]]$overall.se
    type <- C3G_reg[[q]][[j]]$type
    gname <- C3G_reg[[q]][[j]][["DIDparams"]][["gname"]]#comparison
    N <- C3G_reg[[q]][[j]][["DIDparams"]][["n"]]# N
    est_m <- C3G_reg[[q]][[j]][["DIDparams"]][["call"]][["est_method"]]#estimator
    y_name <- C3G_reg[[q]][[j]][["DIDparams"]][["DIDparams"]][["yname"]]
    cont_v <- C3G_reg[[q]][[j]][["DIDparams"]][["DIDparams"]][["xformla"]][[2]]
    m_dt[["c_var"]] <- cont_v
    m_dt[["dep_var"]] <- y_name
    m_dt[["ATT"]] <- att
    m_dt[["SE"]] <- se
    m_dt[["CV"]] <- qt(0.975,df= N-1)
    m_dt[["type"]] <- type
    m_dt[["gname"]] <- gname
    m_dt[["N"]] <- N
    m_dt[["est_m"]] <- est_m
    
    MODELS[[paste0(j,"_",q)]] <- m_dt
  }
}

df_MODEL <- as.data.frame(do.call(rbind, MODELS))
df_MODEL <- tibble::rownames_to_column(df_MODEL, "row_names")


df_MODEL$CV <- as.numeric(df_MODEL$CV)
df_MODEL$SE <- as.numeric(df_MODEL$SE)
df_MODEL$ATT <- as.numeric(df_MODEL$ATT)

#clean columnes
df_MODEL$N <- as.numeric(df_MODEL$N)
df_MODEL$low_conf <- df_MODEL$ATT - (df_MODEL$CV * df_MODEL$SE)
df_MODEL$up_conf<- df_MODEL$ATT + (df_MODEL$CV * df_MODEL$SE)

df_rrst_s <- df_MODEL





```
 
```{r}

#bind all singel modells for the different comparisons
df_RC_G <- rbind(df_nrft_s, df_ftrr_s)
df_RC_G <- rbind(df_RC_G, df_rrst_s)
```


```{r}



#save all models
#fwrite(df_nrft_s, "df_nrft_s.csv")
#fwrite(df_ftrr_s, "df_ftrr_s.csv")
#fwrite(df_rrst_s, "df_rrst_s.csv")

```


```{r}

#get columne for signifikance

#bind all singel modells for the different comparisons
df_RC_reg_s <- rbind(df_RC_G, df_RC_E)

#get new columne for att positive or negativ
df_RC_reg_s <- df_RC_reg_s%>% 
  mutate(
   p_n = case_when(
      ATT > 0 ~ "+",
      ATT < 0 ~ "-"
    ))


df_RC_reg_s <- df_RC_reg_s%>%mutate(
  sig_5 = case_when(
   p_n == "-" & 0 > up_conf ~ "*",
   p_n == "+" & 0 < low_conf ~ "*"
  )
)



#only significnat models
sig5_model_reg <- df_RC_reg_s%>%filter(is.na(sig_5)==F)

#get columne for control vars
df_RC_reg_s$c_var <- gsub(".*_", "", df_RC_reg_s$row_names)

df_RC_reg_s$type <- as.character(df_RC_reg_s$type)
df_RC_reg_s$gname <- as.character(df_RC_reg_s$gname)
df_RC_reg_s$est_m <- as.character(df_RC_reg_s$est_m)

df_RC_reg_s<-unique(df_RC_reg_s)

#####get more significanc levels

#significant on 1% level**
#get critical value for 1% level
df_RC_reg_s$cv_99 <- qt(0.995,df= df_RC_reg_s$N-1)
#get confidence interval
df_RC_reg_s$low_conf_99 <- df_RC_reg_s$ATT - (df_RC_reg_s$cv_99 * df_RC_reg_s$SE)
df_RC_reg_s$up_conf_99<- df_RC_reg_s$ATT + (df_RC_reg_s$cv_99 * df_RC_reg_s$SE)
#mark the significant models with two stars**
df_RC_reg_s <- df_RC_reg_s%>%mutate(
  sig_1 = case_when(
   p_n == "-" & 0 > up_conf_99 ~ "**",
   p_n == "+" & 0 < low_conf_99 ~ "**"
  )
)


#significant on 0,1% level***
#get critical value for 0,1% level
df_RC_reg_s$cv_0.1 <- qt(0.9995,df= df_RC_reg_s$N-1)
#get confidenc interval
df_RC_reg_s$low_conf_0.1 <- df_RC_reg_s$ATT - (df_RC_reg_s$cv_0.1 * df_RC_reg_s$SE)
df_RC_reg_s$up_conf_0.1<- df_RC_reg_s$ATT + (df_RC_reg_s$cv_0.1 * df_RC_reg_s$SE)
#mark the significant models with three stars***
df_RC_reg_s <- df_RC_reg_s%>%mutate(
  sig_0.1 = case_when(
   p_n == "-" & 0 > up_conf_0.1 ~ "***",
   p_n == "+" & 0 < low_conf_0.1 ~ "***"
  )
)


#save data set with all calculated models
write_xlsx(df_RC_reg_s, "~/rent_control/output/DF_reg_s_models.xlsx")
fwrite(df_RC_reg_s, "df_RC_reg_s.csv")
```


